clear
clc

%Otimizações:
%(1) Sistema em malha aberta, sem atrito
%(2) Modelo de atrito descontínuo

%Preprocessamento:
otimizacao = 1;
opcao_m2 = 1;
opcao_sign = 2;
opcaoSignAt = 1;
inc_dsignS = 1;
opcao_atr = 1;
ind_LVC = 0;
[ argumentos ] = zzpreprocess( otimizacao, opcao_m2, opcao_sign, inc_dsignS,...
    opcao_atr, ind_LVC );
%Inclui (indTatr = 1) ou não (indTatr <> 1) o torque de atrito no mod EF:
indTatr = 0;
argumentos.indTatr = indTatr;
argumentos.opcaoSignAt = opcaoSignAt;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
[ parametros ] = aaTenseCal();
FATORenc = parametros.FATORenc;
%Armazenamento em formato de matriz:
M = csvread('e11pW10.txt');
enc1 = M(:,6); %[pulsos/s] Rotor principal
enc2 = M(:,7); %[pulsos/s] Saída do motor
TempoEns = M(:,9); %s

TetapXNM1enc = enc1*FATORenc^-1; %rad/s
TetapX1enc = enc2*FATORenc^-1; %rad/s
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%
%OTIMIZAÇÃO
nbUNM1 = 2;
argumentos.nbUNM1 = nbUNM1;
%Obs.:
%(1) Inclusão de bUNM1 como variável de otimização
%(2) Exclusão de bUNM1 como variável de otimização
switch nbUNM1
    case 1
        varOtm0 = ones(10,1);
    case 2
        varOtm0 = ones(9,1);
    otherwise
        disp('other value for nbUNM1')
end

switch otimizacao
    case 1
        %Entradas (restrições):
        alfaTeta = 20; %RPM/s
        argumentos.alfaTeta = alfaTeta;
        wMax = 10; %RPM
        argumentos.wMax = wMax;
        
        %Conversão de unidades:
        alfaTeta = alfaTeta*(pi/30); %Aceleração máxima [rad/s2]
        wMax = wMax*(pi/30); %Velocidade máxima [rad/s]
    otherwise
        disp('other value')
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
global iter
iter = 0;
%{
%[ sum2Otm0 ] = fIdentCOST( varOtm0, M, argumentos );
sum2Otm0 = 0;
figure
plot(iter,sum2Otm0,'ko')
xlabel('iterações')
ylabel('custo')
grid 
iter = iter + 1;
%}
t0 = argumentos.t0;
dt = argumentos.dt_newmark;
tfRef = argumentos.tf;
Tref = argumentos.T;
nTref = argumentos.nT;
%Otimização para tf0 (dois picos de oscilação da velocidade - 10RPM):
%Obs.: refinar chute inicial varOtm0 -> varOtm010
tf = 7; %s
argumentos.tf = tf;
T = (t0:dt:tf).';
argumentos.T = T;
nT = length(T);
argumentos.nT = nT;
hold on
%fun = @(x)(fIdentCOST( exp(x), M, argumentos ));
fun = @(x)(fIdCOSTplusP2( exp(x), M, argumentos ));
[varOtm,sum2Otm010] = fminsearch(fun,log(varOtm0));
varOtm010 = varOtm;
tf = tfRef; %s
argumentos.tf = tf;
T = (t0:dt:tf).';
argumentos.T = T;
nT = length(T);
argumentos.nT = nT;
hold off
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
hold on
tf = tfRef; %s
argumentos.tf = tf;
argumentos.T = Tref;
argumentos.nT = nTref;
%fun = @(x)(fIdentCOST( exp(x), M, argumentos ));
fun = @(x)(fIdCOSTplusP2( exp(x), M, argumentos ));
[varOtm,sum2Otm10] = fminsearch(fun,log(varOtm010));
varOtm10 = varOtm;
hold off
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
M30 = csvread('e11pW30.txt');
hold on
%fun = @(x)(fIdentCOST( exp(x), M30, argumentos ));
fun = @(x)(fIdCOSTplusP2( exp(x), M30, argumentos ));
[varOtm,sum2Otm] = fminsearch(fun,log(varOtm10));
varOtm3010 = varOtm;
hold off

%%
%RESULTADOS:

d0 = argumentos.d;
L0 = argumentos.L;
L10 = argumentos.L1;
rho0 = argumentos.rho;
E0 = argumentos.E;
nu0 =argumentos.nu;
bUNM10 = argumentos.bUNM1;
bTxNM10 = argumentos.bTxNM1;

switch nbUNM1
    case 1
        d = varOtm(1,1)*d0;
        L = varOtm(2,1)*L0;
        L1 = varOtm(3,1)*L10;
        rho = varOtm(4,1)*rho0;
        E = varOtm(5,1)*E0;
        nu = varOtm(6,1)*nu0;
        bUNM1 = varOtm(7,1)*bUNM10;
        bTxNM1 = varOtm(8,1)*bTxNM10;
        nrho1 = varOtm(9,1);
        nrho2 = varOtm(10,1);
    case 2
        d = varOtm(1,1)*d0;
        L = varOtm(2,1)*L0;
        L1 = varOtm(3,1)*L10;
        rho = varOtm(4,1)*rho0;
        E = varOtm(5,1)*E0;
        nu = varOtm(6,1)*nu0;
        bTxNM1 = varOtm(7,1)*bTxNM10;
        nrho1 = varOtm(8,1);
        nrho2 = varOtm(9,1);
        bUNM1 = bUNM10;
    otherwise
        disp('other value for nbUNM1')
end

%Densidade dos rotores 1 e 2:
rho1 = nrho1*rho;
rho2 = nrho2*rho;

%Malha:
N = argumentos.N;
L2 = L - L1; %m (cumprimento entre rotor intermediário e rotor da extremidade)
N1 = ceil(N*L1/L); %número de elementos em L1
N2 = N - N1; %número de elementos em L2
if N2<1
    N1 = floor(N*L1/L);
    N2 = N - N1;
end
argumentos.N1 = N1;
%2. Malha:
X = zeros(1,N+1);
for i = 1:N+1
    if i<N1+2
        X(i) = (i-1)*L1/N1;
    else
        X(i) = X(N1+1) + (i-N1-1)*L2/N2;
    end
end
argumentos.X = X;

%Parâmetros:
L1b = argumentos.L1b;
Dr1 = argumentos.Dr1;
L2b = argumentos.L2b;
Dr2 = argumentos.Dr2;
Jp1 = pi*Dr1^4/32; %m^4
Ip1 = rho1*Jp1*L1b; %Momento polar do rotor 1
Jp2b = pi*Dr2^4/32;
Ip2b = rho2*Jp2b*L2b;
%I3 = argumentos.Ip3bMt;
A1 = pi*Dr1^2/4; %m^2
M1 = rho1*A1*L1b; %Massa do rotor 1
A2 = pi*Dr2^2/4; %m^2
M2b = rho2*A2*L2b; %Massa do rotor 2
M3 = argumentos.M3_pl;
g = argumentos.g;
G = E/(2*(1 + nu));
Jp = pi*d^4/32; %m^4
A = pi*d^2/4;
l2 = argumentos.l2;
dm = argumentos.dm;
alfaAc = argumentos.alfam2;
J = Jp/2;
nGL = argumentos.nGL;
GamaR = argumentos.GamaR;
rEstr = argumentos.rEstr;
kNmk = argumentos.k_newmark;
Kip = argumentos.Kip;
fg = argumentos.fg;

%Acrescimo de deslocamento longitudinal na traj des acopl y2d:
kNM1 = argumentos.kNM1;

%nUaj = 35;
%uNM1aj = nUaj*(Nref/kNM1); %m
%nFg = 1;
%uNM1aj0 = L - (sqrt(L1^2 - (fg/nFg)^2) + sqrt((L-L1)^2 - (fg/nFg)^2));
%uNM1aj = uNM1aj0;

%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Modelo em Elementos Finitos
I1 = Ip1/2;
%Ip2b = Ib2;
I2 = Ip2b/2;
M3pl = M3;
I3pl = argumentos.I3_pl;
Ip3pl = argumentos.Ip3_pl;
Ip3bMt = argumentos.Ip3bMt;
R = argumentos.raio;
ks = argumentos.ks;
bU1 = argumentos.bU1;
%bUNM1 = argumentos.bUNM1;
bTx1 = argumentos.bTx1;
%bTxNM1 = argumentos.bTxNM1;
R_NM1 = argumentos.R_NM1;

n1 = @(xi, le)(1 - xi);
n2 = @(xi, le)(xi);
H1 = @(xi, le)(1 - 3*xi^2 + 2*xi^3);
H2 = @(xi, le)(le*(xi - 2*xi^2 + xi^3));
H3 = @(xi, le)(3*xi^2 - 2*xi^3);
H4 = @(xi, le)(le*(-xi^2 + xi^3));
%ok, 27/02/2020
dn1dx = @(xi, le)(-1/le);
dn2dx = @(xi, le)(1/le);
dH1dx = @(xi, le)((6*xi*(xi - 1))/le);
dH2dx = @(xi, le)(3*xi^2 - 4*xi + 1);
dH3dx = @(xi, le)(-(6*xi*(xi - 1))/le);
dH4dx = @(xi, le)(xi*(3*xi - 2));
%ok, 27/02/2020
d2H1dx2 = @(xi, le)((6*(2*xi - 1))/le^2);
d2H2dx2 = @(xi, le)((6*xi - 4)/le);
d2H3dx2 = @(xi, le)(-(6*(2*xi - 1))/le^2);
d2H4dx2 = @(xi, le)((6*xi - 2)/le);
%ok, 27/02/2020
Nu = @(xi, le)([n1(xi, le), 0, 0, 0, 0, 0,...
    n2(xi, le), 0, 0, 0, 0, 0]);
repositorio.Nu = Nu;
Nv = @(xi, le)([0, H1(xi, le), H2(xi, le), 0, 0, 0,...
    0, H3(xi, le), H4(xi, le), 0, 0, 0]);
repositorio.Nv = Nv;
NtetaZ = @(xi, le)([0, dH1dx(xi, le), dH2dx(xi, le), 0, 0, 0,...
    0, dH3dx(xi, le), dH4dx(xi, le), 0, 0, 0]);
repositorio.NtetaZ = NtetaZ;
Nw = @(xi, le)([0, 0, 0, H1(xi, le), -H2(xi, le), 0,...
    0, 0, 0, H3(xi, le), -H4(xi, le), 0]);
repositorio.Nw = Nw;
NtetaY = @(xi, le)([0, 0, 0, -dH1dx(xi, le), dH2dx(xi, le), 0,...
    0, 0, 0, -dH3dx(xi, le), dH4dx(xi, le), 0]);
repositorio.NtetaY = NtetaY;
NtetaX = @(xi, le)([0, 0, 0, 0, 0, n1(xi, le),...
    0, 0, 0, 0, 0, n2(xi, le)]);
repositorio.NtetaX = NtetaX;
%ok, 27/02/2020
dNu_dx = @(xi, le)([dn1dx(xi, le), 0, 0, 0, 0, 0,...
    dn2dx(xi, le), 0, 0, 0, 0, 0]);
repositorio.dNu_dx = dNu_dx;
dNv_dx = @(xi, le)([0, dH1dx(xi, le), dH2dx(xi, le), 0, 0, 0,...
    0, dH3dx(xi, le), dH4dx(xi, le), 0, 0, 0]);
repositorio.dNv_dx = dNv_dx;
dNtetaZ_dx = @(xi, le)([0, d2H1dx2(xi, le), d2H2dx2(xi, le), 0, 0, 0,...
    0, d2H3dx2(xi, le), d2H4dx2(xi, le), 0, 0, 0]);
repositorio.dNtetaZ_dx = dNtetaZ_dx;
dNw_dx = @(xi, le)([0, 0, 0, dH1dx(xi, le), -dH2dx(xi, le), 0,...
    0, 0, 0, dH3dx(xi, le), -dH4dx(xi, le), 0]);
repositorio.dNw_dx = dNw_dx;
dNtetaY_dx = @(xi, le)([0, 0, 0, -d2H1dx2(xi, le), d2H2dx2(xi, le), 0,...
    0, 0, 0, -d2H3dx2(xi, le), d2H4dx2(xi, le), 0]);
repositorio.dNtetaY_dx = dNtetaY_dx;
dNtetaX_dx = @(xi, le)([0, 0, 0, 0, 0, dn1dx(xi, le),...
    0, 0, 0, 0, 0, dn2dx(xi, le)]);
repositorio.dNtetaX_dx = dNtetaX_dx;
%ok, 27/02/2020

%u_aprox = @(xi, le, uj)(Nu(xi, le)*uj);
%v_aprox = @(xi, le, uj)(Nv(xi, le)*uj);
tetaZ = @(xi, le, uj)(NtetaZ(xi, le)*uj);
%w_aprox = @(xi, le, uj)(Nw(xi, le)*uj);
tetaY = @(xi, le, uj)(NtetaY(xi, le)*uj);
tetaX = @(xi, le, uj)(NtetaX(xi, le)*uj);
%ok, 27/02/2020
up = @(xi, le, upj)(Nu(xi, le)*upj);
vp = @(xi, le, upj)(Nv(xi, le)*upj);
tetaZp = @(xi, le, upj)(NtetaZ(xi, le)*upj);
wp = @(xi, le, upj)(Nw(xi, le)*upj);
tetaYp = @(xi, le, upj)(NtetaY(xi, le)*upj);
tetaXp = @(xi, le, upj)(NtetaX(xi, le)*upj);
%ok, 27/02/2020
upp = @(xi, le, uppj)(Nu(xi, le)*uppj);
vpp = @(xi, le, uppj)(Nv(xi, le)*uppj);
tetaZpp = @(xi, le, uppj)(NtetaZ(xi, le)*uppj);
wpp = @(xi, le, uppj)(Nw(xi, le)*uppj);
tetaYpp = @(xi, le, uppj)(NtetaY(xi, le)*uppj);
tetaXpp = @(xi, le, uppj)(NtetaX(xi, le)*uppj);
%ok, 05/03/2020
du_dx = @(xi, le, uj)(dNu_dx(xi, le)*uj);
dv_dx = @(xi, le, uj)(dNv_dx(xi, le)*uj);
dtetaZ_dx = @(xi, le, uj)(dNtetaZ_dx(xi, le)*uj);
dw_dx = @(xi, le, uj)(dNw_dx(xi, le)*uj);
dtetaY_dx = @(xi, le, uj)(dNtetaY_dx(xi, le)*uj);
dtetaX_dx = @(xi, le, uj)(dNtetaX_dx(xi, le)*uj);
%ok, 05/03/2020

%%
%(3) Matriz M1 (para termos elementares e concentrados):
%(3.1) Eixo e rotores 1 e 2:
T_m1j_Aux = @(xi, le, rhoA_ou_M, rhoJp_ou_Ip, rhoJ_ou_I)(2*rhoA_ou_M*...
    (Nu(xi, le).'*Nu(xi, le) + Nv(xi, le).'*Nv(xi, le) + Nw(xi, le).'*Nw(xi, le)) +...
    2*rhoJp_ou_Ip*...
    (NtetaX(xi, le).'*NtetaX(xi, le)) +...
    2*rhoJ_ou_I*...
    (NtetaY(xi,le).'*NtetaY(xi,le) + NtetaZ(xi,le).'*NtetaZ(xi,le)));
%repositorio.T_m1j_Aux = T_m1j_Aux;
%ok! 21/12/2021

%(3.2) Excentricidade:
%Termo a ser subtraído de M2 e acrescido a M1, de modo a que M2(0)=0:
T_dmj_dm_Aux = @(xi, le)(2*dm*...
    (l2*((NtetaX(xi, le).')*(Nw(xi, le)*cos(alfaAc)) +...
           (Nw(xi, le).'*cos(alfaAc))*(NtetaX(xi, le)))) +...
    dm*...
    (l2*(((Nu(xi, le).')*(NtetaY(xi, le)*sin(alfaAc) -...
                    NtetaZ(xi, le)*cos(alfaAc))) +...
           ((NtetaY(xi, le).'*sin(alfaAc) - NtetaZ(xi, le).'*cos(alfaAc))*(Nu(xi, le))))) +...
    dm*...
    (l2^2*((NtetaY(xi, le).'*sin(alfaAc) - NtetaZ(xi, le).'*cos(alfaAc))*(NtetaY(xi, le)*sin(alfaAc) - NtetaZ(xi, le)*cos(alfaAc))) -...
     l2*(Nv(xi, le).'*(NtetaX(xi, le)*sin(alfaAc)) +...
        (NtetaX(xi, le).'*sin(alfaAc))*Nv(xi, le))));
%Parcela da matriz M1 referente à massa m2:
T_m1j_m2_Aux = @(xi, le)(2*dm*...
    (Nu(xi, le).'*Nu(xi, le) + Nv(xi, le).'*Nv(xi, le) + Nw(xi, le).'*Nw(xi, le) +...
     l2^2*(NtetaX(xi, le).'*NtetaX(xi, le))) +...
     T_dmj_dm_Aux(xi, le));
%repositorio.T_m1j_m2_Aux = T_m1j_m2_Aux;
%ok! 22/12/2021

%(3.3) Parcela da matriz M1 referente à plataforma móvel:
T_m1j_M3_Aux = @(xi, le)(2*...
    (M3pl*((Nu(xi, le).'*Nu(xi, le)) + (Nv(xi, le).'*Nv(xi, le)) + (Nw(xi, le).'*Nw(xi, le))) +...
     I3pl*(NtetaY(xi, le).'*NtetaY(xi, le)) +...
     I3pl*(NtetaZ(xi, le).'*NtetaZ(xi, le))));
%ok! 24/12/2021

%(3.4) Parcela da matriz M1 referente à inércia interna do motor:
T_m1j_Motor_Aux = @(xi, le)(2*Ip3bMt*(NtetaX(xi, le).'*NtetaX(xi, le)));
%ok! 24/12/2021

%%
%(4) Matriz M2upp (para termos elementares e concentrados):
%(4.1) Eixo e rotores 1 e 2:
T_m2j_Aux = @(xi, le, uj, rhoJp_ou_Ip)(2*rhoJp_ou_Ip*...
    (tetaZ(xi,le,uj)*...
    (NtetaX(xi,le).'*NtetaY(xi,le) + NtetaY(xi,le).'*NtetaX(xi,le)) +...
    tetaZ(xi,le,uj)^2*...
    (NtetaY(xi,le).'*NtetaY(xi,le))));
%repositorio.T_m2j_Aux = T_m2j_Aux;
%ok! 21/12/2021
T_m2juppj_Aux = @(xi, le, uj, uppj, rhoJp_ou_Ip)(2*rhoJp_ou_Ip*...
    (tetaZ(xi,le,uj)*...
    (NtetaX(xi,le).'*tetaYpp(xi,le,uppj) + NtetaY(xi,le).'*tetaXpp(xi,le,uppj)) +...
    tetaZ(xi,le,uj)^2*...
    (NtetaY(xi,le).'*tetaYpp(xi,le,uppj))));
%repositorio.T_m2juppj_Aux = T_m2juppj_Aux;
%ok! 21/12/2021
T_dm2juppj_dujT_Aux = @(xi, le, uj, uppj, rhoJp_ou_Ip)(2*rhoJp_ou_Ip*...
    (tetaYpp(xi,le,uppj)*...
     (NtetaX(xi,le).'*NtetaZ(xi,le) +...
      2*tetaZ(xi,le,uj)*NtetaY(xi,le).'*NtetaZ(xi,le)) +...
     tetaXpp(xi,le,uppj)*...
     (NtetaY(xi,le).'*NtetaZ(xi,le))));
%repositorio.T_m2juppj_Aux = T_dm2juppj_dujT_Aux;
%ok! 21/12/2021

%(4.2) Excentricidade:
T_m2j_m2_Aux = @(xi, le, uj)(dm*...
    (l2^2*(2*tetaZ(xi, le, uj)*(NtetaX(xi, le).'*NtetaY(xi, le) + NtetaY(xi, le).'*NtetaX(xi, le)) +...
           2*tetaZ(xi, le, uj)^2*(NtetaY(xi, le).'*NtetaY(xi, le))) +...
     (tetaZ(xi, le, uj)^2*(2*(Nv(xi, le).'*Nv(xi, le)) + 2*(Nu(xi, le).'*Nu(xi, le)))) +...
     (tetaY(xi, le, uj)^2*(2*(Nw(xi, le).'*Nw(xi, le)) + 2*(Nu(xi, le).'*Nu(xi, le))))) +...
    dm*...
    (2*l2*(((NtetaX(xi, le).' + NtetaY(xi, le).'*tetaZ(xi, le, uj))*(((tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc))*Nu(xi, le)) +...
                                         (cos(tetaX(xi, le, uj) + alfaAc)*Nw(xi, le)))) +...
           ((Nw(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) + Nu(xi, le).'*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)))*(NtetaX(xi, le) + (NtetaY(xi, le)*tetaZ(xi, le, uj)))))) +...
    dm*...
    (2*l2*(((Nu(xi, le).' - Nw(xi, le).'*tetaY(xi, le, uj))*((NtetaY(xi, le)*sin(tetaX(xi, le, uj) + alfaAc)) -...
                                                             (NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc)))) +...
           ((NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc))*(Nu(xi, le) - (Nw(xi, le)*tetaY(xi, le, uj)))))) +...
    dm*...
    (l2^2*2*((NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc))*(NtetaY(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc))) -...
     2*(Nv(xi, le).'*((Nw(xi, le)*tetaZ(xi, le, uj)*tetaY(xi, le, uj)) +...
              (tetaZ(xi, le, uj)*NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc))*l2 +...
              (NtetaX(xi, le)*sin(tetaX(xi, le, uj) + alfaAc))*l2) +...
        ((Nw(xi, le).'*tetaZ(xi, le, uj)*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*l2*NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) + l2*NtetaX(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc))*Nv(xi, le)))) -...
    T_dmj_dm_Aux(xi, le));
%repositorio.T_m2j_m2_Aux = T_m2j_m2_Aux;
%ok! 22/12/2021
T_m2juppj_m2_Aux = @(xi, le, uj, uppj)(...
    dm*...
    (l2^2*(2*tetaZ(xi, le, uj)*(NtetaX(xi, le).'*tetaYpp(xi, le, uppj) + tetaXpp(xi, le, uppj)*NtetaY(xi, le).') +...
           2*tetaYpp(xi, le, uppj)*tetaZ(xi, le, uj)^2*NtetaY(xi, le).') +...
     (tetaZ(xi, le, uj)^2*(2*vpp(xi, le, uppj)*Nv(xi, le).' + 2*upp(xi, le, uppj)*Nu(xi, le).')) +...
     (tetaY(xi, le, uj)^2*(2*wpp(xi, le, uppj)*Nw(xi, le).' + 2*upp(xi, le, uppj)*Nu(xi, le).'))) +...
    dm*...
    (2*l2*(((NtetaX(xi, le).' + NtetaY(xi, le).'*tetaZ(xi, le, uj))*((upp(xi, le, uppj)*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc))) +...
                                                     (wpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc)))) +...
           ((tetaXpp(xi, le, uppj) + (tetaYpp(xi, le, uppj)*tetaZ(xi, le, uj)))*(Nw(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) +...
                                                                                 Nu(xi, le).'*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) +...
                                                                                               tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)))))) +...
    dm*...
    (2*l2*(((Nu(xi, le).' - Nw(xi, le).'*tetaY(xi, le, uj))*((tetaYpp(xi, le, uppj)*sin(tetaX(xi, le, uj) + alfaAc)) -...
                                                             (tetaZpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc)))) +...
           ((upp(xi, le, uppj) - (wpp(xi, le, uppj)*tetaY(xi, le, uj)))*(NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) -...
                                                                         NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc))))) +...
    dm*...
    (l2^2*2*(((tetaYpp(xi, le, uppj)*sin(tetaX(xi, le, uj) + alfaAc)) - (tetaZpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc)))*(NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc))) -...
     2*(Nv(xi, le).'*((wpp(xi, le, uppj)*tetaZ(xi, le, uj)*tetaY(xi, le, uj)) +...
                      (tetaZ(xi, le, uj)*tetaZpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc))*l2 +...
                      (tetaXpp(xi, le, uppj)*sin(tetaX(xi, le, uj) + alfaAc))*l2) +...
        (vpp(xi, le, uppj)*(Nw(xi, le).'*tetaZ(xi, le, uj)*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*l2*NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) + l2*NtetaX(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc))))) -...
    T_dmj_dm_Aux(xi, le)*uppj);
%repositorio.T_m2juppj_m2_Aux = T_m2juppj_m2_Aux;
%ok! 22/12/2021
T_dm2juppjdujT_m2_Aux = @(xi, le, uj, uppj)(dm*...
    (l2^2*(2*(NtetaX(xi, le).'*tetaYpp(xi, le, uppj) + tetaXpp(xi, le, uppj)*NtetaY(xi, le).')*NtetaZ(xi, le) +...
           2*tetaYpp(xi, le, uppj)*NtetaY(xi, le).'*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)) +...
     ((2*vpp(xi, le, uppj)*Nv(xi, le).' + 2*upp(xi, le, uppj)*Nu(xi, le).')*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)) +...
     ((2*wpp(xi, le, uppj)*Nw(xi, le).' + 2*upp(xi, le, uppj)*Nu(xi, le).')*2*tetaY(xi, le, uj)*NtetaY(xi, le))) +...
    dm*...
    (2*l2*((((NtetaY(xi, le).'*NtetaZ(xi, le))*((upp(xi, le, uppj)*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc))) +...
                                                (wpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc))) +...
             (NtetaX(xi, le).' + NtetaY(xi, le).'*tetaZ(xi, le, uj))*((upp(xi, le, uppj)*((NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) + (NtetaY(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)))) +...
                                                                      (-wpp(xi, le, uppj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))))) +...
           ((Nw(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) + Nu(xi, le).'*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)))*(tetaYpp(xi, le, uppj)*NtetaZ(xi, le)) +...
            (tetaXpp(xi, le, uppj) + (tetaYpp(xi, le, uppj)*tetaZ(xi, le, uj)))*(-Nw(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + Nu(xi, le).'*((NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) + (NtetaY(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))))))) +...
    dm*...
    (2*l2*(((-Nw(xi, le).'*NtetaY(xi, le))*((tetaYpp(xi, le, uppj)*sin(tetaX(xi, le, uj) + alfaAc)) -...
                                            (tetaZpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc))) +...
            (Nu(xi, le).' - Nw(xi, le).'*tetaY(xi, le, uj))*(tetaYpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) +...
                                                             tetaZpp(xi, le, uppj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))) +...
           ((NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc))*(-wpp(xi, le, uppj)*NtetaY(xi, le)) + (upp(xi, le, uppj) - (wpp(xi, le, uppj)*tetaY(xi, le, uj)))*(NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))))) +...
    dm*...
    (l2^2*2*((NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc))*(tetaYpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + tetaZpp(xi, le, uppj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
             (tetaYpp(xi, le, uppj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc))*(NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))) -...
     2*(Nv(xi, le).'*(wpp(xi, le, uppj)*(NtetaZ(xi, le)*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*NtetaY(xi, le)) +...
                      tetaZpp(xi, le, uppj)*(NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*l2 +...
              tetaXpp(xi, le, uppj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*l2) +...
        (vpp(xi, le, uppj)*(Nw(xi, le).'*(NtetaZ(xi, le)*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*NtetaY(xi, le)) +...
              NtetaZ(xi, le).'*(NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*l2 +...
              NtetaX(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*l2)))));
%repositorio.T_dm2juppj_dujT_m2_Aux = T_dm2juppj_dujT_m2_Aux;
%ok! 22/12/2021

%(4.3) Plataforma móvel:
T_m2j_M3_Aux = @(xi, le, uj)(2*Ip3pl*...
    tetaZ(xi,le,uj)^2*(NtetaY(xi,le).'*NtetaY(xi,le)));
%repositorio.T_m2j_M3_Aux = T_m2j_M3_Aux;
%ok! 27/12/2021
T_m2uppj_M3_Aux = @(xi, le, uj, uppj)(2*Ip3pl*...
    tetaZ(xi,le,uj)^2*(NtetaY(xi,le).'*tetaYpp(xi,le,uppj)));
%repositorio.T_m2uppj_M3_Aux = T_m2uppj_M3_Aux;
%ok! 27/12/2021
T_dm2juppjdujT_M3_Aux = @(xi, le, uj, uppj)(2*Ip3pl*...
    (NtetaY(xi,le).'*tetaYpp(xi,le,uppj))*2*tetaZ(xi,le,uj)*NtetaZ(xi,le));
%repositorioT_dm2juppj_dujT_M3_Aux = T_dm2juppj_dujT_M3_Aux;
%ok! 27/12/2021

%%
%(5) Vetor giroscópico Gc (para termos elementares e concentrados):
%(5.1) Eixo e rotores 1 e 2:
T_gCj_Aux = @(xi, le, uj, upj, rhoJp_ou_Ip)(2*rhoJp_ou_Ip*tetaYp(xi, le, upj)*...
    (NtetaX(xi, le).'*tetaZp(xi, le, upj)*tetaYp(xi, le, upj) +...
     NtetaY(xi, le).'*tetaZp(xi, le, upj)*(tetaXp(xi, le, upj) + 2*tetaZ(xi, le, uj)*tetaYp(xi, le, upj)) -...
     NtetaZ(xi, le).'*tetaYp(xi, le, upj)*(tetaXp(xi, le, upj) + tetaZ(xi, le, uj)*tetaYp(xi, le, upj))));
%repositorio.T_gCj_Aux = T_gCj_Aux;
%ok, 21/12/2021
T_dgCjdujT_Aux = @(xi, le, upj, rhoJp_ou_Ip)(2*rhoJp_ou_Ip*...
    (NtetaY(xi, le).'*tetaZp(xi, le, upj)*(2*NtetaZ(xi, le)*tetaYp(xi, le, upj)) -...
     NtetaZ(xi, le).'*tetaYp(xi, le, upj)*(NtetaZ(xi, le)*tetaYp(xi, le, upj))));
%repositorio.T_dgCj_dujT_Aux = T_dgCj_dujT_Aux;
%ok, 21/12/2021
T_dgCjdupjT_Aux = @(xi, le, uj, upj, rhoJp_ou_Ip)(2*rhoJp_ou_Ip*...
    (NtetaX(xi, le).'*(NtetaZ(xi, le)*tetaYp(xi, le, upj) + tetaZp(xi, le, upj)*NtetaY(xi, le)) +...
     NtetaY(xi, le).'*(NtetaZ(xi, le)*(tetaXp(xi, le, upj) + 2*tetaZ(xi, le, uj)*tetaYp(xi, le, upj)) +...
                       tetaZp(xi, le, upj)*(NtetaX(xi, le) + 2*tetaZ(xi, le, uj)*NtetaY(xi, le))) -...
     NtetaZ(xi, le).'*(NtetaY(xi, le)*(tetaXp(xi, le, upj) + tetaZ(xi, le, uj)*tetaYp(xi, le, upj)) +...
                       tetaYp(xi, le, upj)*(NtetaX(xi, le) + tetaZ(xi, le, uj)*NtetaY(xi, le)))));
%repositorio.T_dgCj_dupjT_Aux = T_dgCj_dupjT_Aux;
%ok, 21/12/2021

%(5.2) Excentricidade:
T_gCj_m2_Aux = @(xi, le, uj, upj)(dm*...
    (l2^2*(2*(tetaZp(xi, le, upj)*(NtetaX(xi, le).'*tetaYp(xi, le, upj) + tetaXp(xi, le, upj)*NtetaY(xi, le).')) +...
           2*(2*tetaZ(xi, le, uj)*tetaYp(xi, le, upj)*tetaZp(xi, le, upj))*NtetaY(xi, le).') +...
     (2*tetaZ(xi, le, uj)*tetaZp(xi, le, upj)*(2*vp(xi, le, upj)*Nv(xi, le).' + 2*up(xi, le, upj)*Nu(xi, le).')) +...
     (2*tetaY(xi, le, uj)*tetaYp(xi, le, upj)*(2*wp(xi, le, upj)*Nw(xi, le).' + 2*up(xi, le, upj)*Nu(xi, le).'))) +...
    dm*...
    (2*l2*(((NtetaY(xi, le).'*tetaZp(xi, le, upj))*(up(xi, le, upj)*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)) + wp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)) +...
            (NtetaX(xi, le).' + NtetaY(xi, le).'*tetaZ(xi, le, uj))*((up(xi, le, upj)*((tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) +...
                                              (tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)))) +...
                                         (-wp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)))) +...
           (((tetaYp(xi, le, upj)*tetaZp(xi, le, upj)))*(Nw(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) + Nu(xi, le).'*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc))) +...
            (tetaXp(xi, le, upj) + tetaYp(xi, le, upj)*tetaZ(xi, le, uj))*(-Nw(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) +...
                                     Nu(xi, le).'*((tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) +...
                                           (tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))))))) +...
    dm*...
    (2*l2*(((-Nw(xi, le).'*tetaYp(xi, le, upj))*(tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)) +...
            (Nu(xi, le).' - Nw(xi, le).'*tetaY(xi, le, uj))*((tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) -...
                                 (-tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)))) +...
           ((-(wp(xi, le, upj)*tetaYp(xi, le, upj)))*(NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)) +...
            (up(xi, le, upj) - wp(xi, le, upj)*tetaY(xi, le, uj))*(NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))))) +...
    dm*...
    (l2^2*2*(((tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) - (-tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)))*(NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)) +...
             (tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc))*(NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))) -...
     2*(Nv(xi, le).'*((wp(xi, le, upj)*tetaZp(xi, le, upj)*tetaY(xi, le, uj) + wp(xi, le, upj)*tetaZ(xi, le, uj)*tetaYp(xi, le, upj)) +...
              (tetaZp(xi, le, upj)^2*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))*l2 +...
              (tetaXp(xi, le, upj)^2*cos(tetaX(xi, le, uj) + alfaAc))*l2) +...
        (vp(xi, le, upj)*(Nw(xi, le).'*(tetaZp(xi, le, upj)*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*tetaYp(xi, le, upj)) +...
             l2*NtetaZ(xi, le).'*(tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) +...
             l2*NtetaX(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))))) -...
    dm*(l2^2*(2*tetaXp(xi, le, upj)*tetaYp(xi, le, upj) + tetaYp(xi, le, upj)^2*2*tetaZ(xi, le, uj))*NtetaZ(xi, le).' +...
    2*tetaZ(xi, le, uj)*NtetaZ(xi, le).'*(vp(xi, le, upj)^2 + up(xi, le, upj)^2) +...
    2*tetaY(xi, le, uj)*NtetaY(xi, le).'*(wp(xi, le, upj)^2 + up(xi, le, upj)^2) +...
    2*l2*((tetaYp(xi, le, upj)*NtetaZ(xi, le).')*(up(xi, le, upj)*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)) + wp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)) +...
          (tetaXp(xi, le, upj) + tetaYp(xi, le, upj)*tetaZ(xi, le, uj))*(up(xi, le, upj)*((NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).') +...
                                       (NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).')) - wp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).')) +...
    2*l2*((-wp(xi, le, upj)*NtetaY(xi, le).')*(tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)) +...
          (up(xi, le, upj) - wp(xi, le, upj)*tetaY(xi, le, uj))*(tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc))*NtetaX(xi, le).') +...
    l2^2*2*(tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc))*(tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc))*NtetaX(xi, le).' -...
    2*vp(xi, le, upj)*(wp(xi, le, upj)*(NtetaZ(xi, le).'*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*NtetaY(xi, le).') +...
    l2*tetaZp(xi, le, upj)*(NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).') +...
    l2*tetaXp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).')));
%repositorio.T_gCj_m2_Aux = T_gCj_m2_Aux;
T_dgCjdujT_m2_Aux = @(xi, le, uj, upj)(dm*...
    (l2^2*(2*(2*tetaYp(xi, le, upj)*tetaZp(xi, le, upj))*(NtetaY(xi, le).'*NtetaZ(xi, le))) +...
     (2*tetaZp(xi, le, upj)*(2*vp(xi, le, upj)*Nv(xi, le).' + 2*up(xi, le, upj)*Nu(xi, le).')*NtetaZ(xi, le)) +...
     (2*tetaYp(xi, le, upj)*(2*wp(xi, le, upj)*Nw(xi, le).' + 2*up(xi, le, upj)*Nu(xi, le).')*NtetaY(xi, le))) +...
    dm*...
    (2*l2*(((NtetaY(xi, le).'*tetaZp(xi, le, upj))*(up(xi, le, upj)*((NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
                                   (NtetaY(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))) -...
                               wp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
            ((NtetaY(xi, le).'*NtetaZ(xi, le))*((up(xi, le, upj)*((tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) +...
                                              (tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)))) +...
                                (-wp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))) +...
             (NtetaX(xi, le).' + NtetaY(xi, le).'*tetaZ(xi, le, uj))*((up(xi, le, upj)*((tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + (NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*tetaXp(xi, le, upj)) +...
                                               (-tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) - (NtetaY(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*tetaXp(xi, le, upj)))) +...
                                          (-wp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj))))) +...
           ((tetaYp(xi, le, upj)*tetaZp(xi, le, upj))*(-Nw(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) +...
                             Nu(xi, le).'*((NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
                                   (NtetaY(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)))) +...
            ((-Nw(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) +...
              Nu(xi, le).'*((tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) +...
                    (tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))))*(tetaYp(xi, le, upj)*NtetaZ(xi, le)) +...
             (tetaXp(xi, le, upj) + tetaYp(xi, le, upj)*tetaZ(xi, le, uj))*(-Nw(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj) +...
                                      Nu(xi, le).'*((tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + (NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*tetaXp(xi, le, upj)) +...
                                            (-tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) - (NtetaY(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*tetaXp(xi, le, upj)))))))) +...
    dm*...
    (2*l2*(((-Nw(xi, le).'*tetaYp(xi, le, upj))*(tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
            ((-Nw(xi, le).'*NtetaY(xi, le))*((tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) +...
                             (tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))) +...
             (Nu(xi, le).' - Nw(xi, le).'*tetaY(xi, le, uj))*((-tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj)) -...
                                  (-tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj))))) +...
           ((-wp(xi, le, upj)*tetaYp(xi, le, upj))*(NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
            ((NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))*(-wp(xi, le, upj)*NtetaY(xi, le)) +...
             (up(xi, le, upj) - wp(xi, le, upj)*tetaY(xi, le, uj))*(-NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj) + NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj)))))) +...
    dm*...
    (l2^2*2*(((NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc))*(-tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj) + tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj)) +...
              (tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))*(NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))) +...
             ((NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))*(tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
              (tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc))*(-NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj) + NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj)))) -...
     2*(Nv(xi, le).'*((wp(xi, le, upj)*tetaZp(xi, le, upj)*NtetaY(xi, le) + wp(xi, le, upj)*NtetaZ(xi, le)*tetaYp(xi, le, upj)) +...
              (-tetaZp(xi, le, upj)^2*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) - (NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*tetaZp(xi, le, upj)*tetaXp(xi, le, upj))*l2 +...
              (-tetaXp(xi, le, upj)^2*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*l2) +...
        vp(xi, le, upj)*(Nw(xi, le).'*(tetaZp(xi, le, upj)*NtetaY(xi, le) + NtetaZ(xi, le)*tetaYp(xi, le, upj)) +...
            l2*NtetaZ(xi, le).'*(-tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) - (NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*tetaXp(xi, le, upj)) -...
            l2*NtetaX(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)*tetaXp(xi, le, upj)))) -...
    dm*...
    (l2^2*NtetaZ(xi, le).'*(tetaYp(xi, le, upj)^2*2*NtetaZ(xi, le)) +...
     2*NtetaZ(xi, le).'*(vp(xi, le, upj)^2 + up(xi, le, upj)^2)*NtetaZ(xi, le) +...
     2*NtetaY(xi, le).'*(wp(xi, le, upj)^2 + up(xi, le, upj)^2)*NtetaY(xi, le) +...
     2*l2*((tetaYp(xi, le, upj)*NtetaZ(xi, le).')*(up(xi, le, upj)*((NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
                                  (NtetaY(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))) -...
                              wp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
           ((up(xi, le, upj)*((NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) +...
                  NtetaX(xi, le).'*(NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))) +...
                 (-NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) -...
                  NtetaX(xi, le).'*(NtetaY(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)))) -...
             wp(xi, le, upj)*NtetaX(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*(tetaXp(xi, le, upj) + tetaYp(xi, le, upj)*tetaZ(xi, le, uj)) +...
            (up(xi, le, upj)*((NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).') +...
                 (NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).')) -...
             wp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).')*(tetaYp(xi, le, upj)*NtetaZ(xi, le)))) +...
     2*l2*((-wp(xi, le, upj)*NtetaY(xi, le).')*(tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
           NtetaX(xi, le).'*((-wp(xi, le, upj)*NtetaY(xi, le))*(tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)) +...
                     (up(xi, le, upj) - wp(xi, le, upj)*tetaY(xi, le, uj))*(-tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)))) +...
     l2^2*2*NtetaX(xi, le).'*((tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))*(tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)) +...
                      (tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc))*(-tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))) -...
     2*vp(xi, le, upj)*(wp(xi, le, upj)*(NtetaZ(xi, le).'*NtetaY(xi, le) + NtetaY(xi, le).'*NtetaZ(xi, le)) +...
           l2*tetaZp(xi, le, upj)*(-NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) - NtetaX(xi, le).'*(NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))) -...
           l2*tetaXp(xi, le, upj)*NtetaX(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))));
%repositorio.T_dgCj_dujT_m2_Aux = T_dgCj_dujT_m2_Aux;
T_dgCjdupjT_m2_Aux = @(xi, le, uj, upj)(dm*...
    (l2^2*(2*(((NtetaX(xi, le).'*tetaYp(xi, le, upj) + tetaXp(xi, le, upj)*NtetaY(xi, le).')*NtetaZ(xi, le) +...
               tetaZp(xi, le, upj)*(NtetaX(xi, le).'*NtetaY(xi, le) + NtetaY(xi, le).'*NtetaX(xi, le)))) +...
           2*(2*tetaZ(xi, le, uj))*NtetaY(xi, le).'*(NtetaY(xi, le)*tetaZp(xi, le, upj) + tetaYp(xi, le, upj)*NtetaZ(xi, le))) +...
     (2*tetaZ(xi, le, uj)*((2*vp(xi, le, upj)*Nv(xi, le).' + 2*up(xi, le, upj)*Nu(xi, le).')*NtetaZ(xi, le) + 2*tetaZp(xi, le, upj)*(Nv(xi, le).'*Nv(xi, le) + Nu(xi, le).'*Nu(xi, le)))) +...
     (2*tetaY(xi, le, uj)*((2*wp(xi, le, upj)*Nw(xi, le).' + 2*up(xi, le, upj)*Nu(xi, le).')*NtetaY(xi, le) + 2*tetaYp(xi, le, upj)*(Nw(xi, le).'*Nw(xi, le) + Nu(xi, le).'*Nu(xi, le))))) +...
    dm*...
    (2*l2*((((NtetaY(xi, le).'*NtetaZ(xi, le))*(up(xi, le, upj)*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)) + wp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)) +...
             (NtetaY(xi, le).'*tetaZp(xi, le, upj))*(Nu(xi, le)*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)) + Nw(xi, le)*cos(tetaX(xi, le, uj) + alfaAc))) +...
            (NtetaX(xi, le).' + NtetaY(xi, le).'*tetaZ(xi, le, uj))*((Nu(xi, le)*((tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) +...
                                              (tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))) +...
                                          up(xi, le, upj)*((NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
                                              (NtetaY(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)))) +...
                                         (-sin(tetaX(xi, le, uj) + alfaAc)*(Nw(xi, le)*tetaXp(xi, le, upj) + wp(xi, le, upj)*NtetaX(xi, le))))) +...
           ((Nw(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) + Nu(xi, le).'*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)))*(NtetaY(xi, le)*tetaZp(xi, le, upj) + tetaYp(xi, le, upj)*NtetaZ(xi, le)) +...
            ((-Nw(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) +...
              Nu(xi, le).'*((tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) +...
                    (tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))))*(NtetaX(xi, le) + NtetaY(xi, le)*tetaZ(xi, le, uj)) +...
             (tetaXp(xi, le, upj) + tetaYp(xi, le, upj)*tetaZ(xi, le, uj))*(-Nw(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) +...
                                      Nu(xi, le).'*((NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
                                            (NtetaY(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)))))))) +...
    dm*...
    (2*l2*((-Nw(xi, le).'*(NtetaY(xi, le)*(tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)) +...
                   tetaYp(xi, le, upj)*(NtetaY(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc))) +...
            (Nu(xi, le).' - Nw(xi, le).'*tetaY(xi, le, uj))*(cos(tetaX(xi, le, uj) + alfaAc)*(NtetaY(xi, le)*tetaXp(xi, le, upj) + tetaYp(xi, le, upj)*NtetaX(xi, le)) +...
                                 sin(tetaX(xi, le, uj) + alfaAc)*(NtetaZ(xi, le)*tetaXp(xi, le, upj) + tetaZp(xi, le, upj)*NtetaX(xi, le)))) +...
           (-(NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc))*(Nw(xi, le)*tetaYp(xi, le, upj) + wp(xi, le, upj)*NtetaY(xi, le)) +...
            ((NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))*(Nu(xi, le) - Nw(xi, le)*tetaY(xi, le, uj)) +...
             (up(xi, le, upj) - wp(xi, le, upj)*tetaY(xi, le, uj))*(NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)))))) +...
    dm*...
    (l2^2*2*((NtetaY(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc))*(cos(tetaX(xi, le, uj) + alfaAc)*(NtetaY(xi, le)*tetaXp(xi, le, upj) + tetaYp(xi, le, upj)*NtetaX(xi, le)) + sin(tetaX(xi, le, uj) + alfaAc)*(NtetaZ(xi, le)*tetaXp(xi, le, upj) + tetaZp(xi, le, upj)*NtetaX(xi, le))) +...
             ((NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))*(NtetaY(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc)) +...
              (tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc))*(NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le) + NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)))) -...
     2*(Nv(xi, le).'*(((Nw(xi, le)*tetaZp(xi, le, upj) + wp(xi, le, upj)*NtetaZ(xi, le))*tetaY(xi, le, uj) + (Nw(xi, le)*tetaYp(xi, le, upj) + wp(xi, le, upj)*NtetaY(xi, le))*tetaZ(xi, le, uj)) +...
              (2*tetaZp(xi, le, upj)*NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*(NtetaZ(xi, le)*tetaXp(xi, le, upj) + tetaZp(xi, le, upj)*NtetaX(xi, le)))*l2 +...
              (2*tetaXp(xi, le, upj)*NtetaX(xi, le)*cos(tetaX(xi, le, uj) + alfaAc))*l2) +...
        ((Nw(xi, le).'*(tetaZp(xi, le, upj)*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*tetaYp(xi, le, upj)) +...
          l2*NtetaZ(xi, le).'*(tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj)) +...
          l2*NtetaX(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*tetaXp(xi, le, upj))*Nv(xi, le) +...
         vp(xi, le, upj)*(Nw(xi, le).'*(NtetaZ(xi, le)*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*NtetaY(xi, le)) +...
             l2*NtetaZ(xi, le).'*(NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le)) +...
             l2*NtetaX(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le))))) -...
    dm*...
    (2*l2^2*NtetaZ(xi, le).'*((NtetaX(xi, le)*tetaYp(xi, le, upj) + tetaXp(xi, le, upj)*NtetaY(xi, le)) + 2*tetaYp(xi, le, upj)*NtetaY(xi, le)*tetaZ(xi, le, uj)) +...
     2*tetaZ(xi, le, uj)*NtetaZ(xi, le).'*(2*vp(xi, le, upj)*Nv(xi, le) + 2*up(xi, le, upj)*Nu(xi, le)) +...
     2*tetaY(xi, le, uj)*NtetaY(xi, le).'*(2*wp(xi, le, upj)*Nw(xi, le) + 2*up(xi, le, upj)*Nu(xi, le)) +...
     2*l2*(((NtetaZ(xi, le).'*NtetaY(xi, le))*(up(xi, le, upj)*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)) + wp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)) +...
            (tetaYp(xi, le, upj)*NtetaZ(xi, le).')*(Nu(xi, le)*(tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc) + tetaY(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)) + Nw(xi, le)*cos(tetaX(xi, le, uj) + alfaAc))) +...
           ((up(xi, le, upj)*((NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).') +...
                 (NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).')) -...
             wp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).')*(NtetaX(xi, le) + NtetaY(xi, le)*tetaZ(xi, le, uj)) +...
            (tetaXp(xi, le, upj) + tetaYp(xi, le, upj)*tetaZ(xi, le, uj))*(((NtetaZ(xi, le).'*sin(tetaX(xi, le, uj) + alfaAc) + tetaZ(xi, le, uj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).') +...
                                         (NtetaY(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) - tetaY(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).'))*Nu(xi, le) -...
                                     sin(tetaX(xi, le, uj) + alfaAc)*(NtetaX(xi, le).'*Nw(xi, le))))) +...
     2*l2*(((-NtetaY(xi, le).'*Nw(xi, le))*(tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)) +...
            (-wp(xi, le, upj)*NtetaY(xi, le).')*(NtetaY(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc))) +...
           NtetaX(xi, le).'*((Nu(xi, le) - Nw(xi, le)*tetaY(xi, le, uj))*(tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)) +...
                     (up(xi, le, upj) - wp(xi, le, upj)*tetaY(xi, le, uj))*(NtetaY(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) + NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc)))) +...
     l2^2*2*NtetaX(xi, le).'*((NtetaY(xi, le)*sin(tetaX(xi, le, uj) + alfaAc) - NtetaZ(xi, le)*cos(tetaX(xi, le, uj) + alfaAc))*(tetaYp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc) + tetaZp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc)) +...
                      (tetaYp(xi, le, upj)*sin(tetaX(xi, le, uj) + alfaAc) - tetaZp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc))*(NtetaY(xi, le)*cos(tetaX(xi, le, uj) + alfaAc) + NtetaZ(xi, le)*sin(tetaX(xi, le, uj) + alfaAc))) -...
     2*((wp(xi, le, upj)*(NtetaZ(xi, le).'*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*NtetaY(xi, le).') +...
         l2*tetaZp(xi, le, upj)*(NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).') +...
         l2*tetaXp(xi, le, upj)*cos(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).')*Nv(xi, le) +...
        vp(xi, le, upj)*((NtetaZ(xi, le).'*tetaY(xi, le, uj) + tetaZ(xi, le, uj)*NtetaY(xi, le).')*Nw(xi, le) +...
            l2*(NtetaZ(xi, le).'*cos(tetaX(xi, le, uj) + alfaAc) - tetaZ(xi, le, uj)*sin(tetaX(xi, le, uj) + alfaAc)*NtetaX(xi, le).')*NtetaZ(xi, le) +...
            l2*cos(tetaX(xi, le, uj) + alfaAc)*(NtetaX(xi, le).'*NtetaX(xi, le))))));
%repositorio.T_dgCj_dupjT_m2_Aux = T_dgCj_dupjT_m2_Aux;

%(5.3) Plataforma móvel:
T_gCj_M3_Aux = @(xi, le, uj, upj)(2*Ip3pl*...
    (NtetaY(xi, le).'*tetaZp(xi, le, upj)*(2*tetaZ(xi, le, uj)*tetaYp(xi, le, upj)) -...
     NtetaZ(xi, le).'*tetaYp(xi, le, upj)*(tetaZ(xi, le, uj)*tetaYp(xi, le, upj))));
%27/12/2021
T_dgCjdujT_M3_Aux = @(xi, le, uj, upj)(2*Ip3pl*...
    (NtetaY(xi, le).'*tetaZp(xi, le, upj)*(2*NtetaZ(xi, le)*tetaYp(xi, le, upj)) -...
     NtetaZ(xi, le).'*tetaYp(xi, le, upj)*(NtetaZ(xi, le)*tetaYp(xi, le, upj))));
%27/12/2021
T_dgCjdupjT_M3_Aux = @(xi, le, uj, upj)(2*Ip3pl*...
    (NtetaY(xi, le).'*2*tetaZ(xi, le, uj)*(NtetaZ(xi, le)*tetaYp(xi, le, upj) + tetaZp(xi, le, upj)*NtetaY(xi, le)) -...
     NtetaZ(xi, le).'*tetaZ(xi, le, uj)*2*tetaYp(xi, le, upj)*NtetaY(xi, le)));
%27/12/2021

%%
%(5) Matriz K (para termos elementares):
%{
piR2E = @(xi, le)(2*(dNu_dx(xi, le).'*dNu_dx(xi, le)));
%ok! 01/03/2020
piR2ksG = @(xi, le)(2*...
    (dNv_dx(xi, le).'*dNv_dx(xi, le) +...
    dNw_dx(xi, le).'*dNw_dx(xi, le) +...
    NtetaY(xi, le).'*NtetaY(xi, le) +...
    NtetaZ(xi, le).'*NtetaZ(xi, le)));
%ok! 01/03/2020
piR4E = @(xi, le)((1/4)*(2*...
    (dNtetaY_dx(xi, le).'*dNtetaY_dx(xi, le) +...
    dNtetaZ_dx(xi, le).'* dNtetaZ_dx(xi, le))));
%ok! 01/03/2020
piR4ksG = @(xi, le)((1/2)*...
    (2*...
    (dNtetaX_dx(xi, le).'*dNtetaX_dx(xi, le))));
%ok! 01/03/2020
U_kj_Aux = @(xi, le)(...
    (pi*R^2*E)*piR2E(xi, le) +...
    (pi*R^2*ks*G)*piR2ksG(xi, le) +...
    (pi*R^4*E)*piR4E(xi, le) +...
    (pi*R^4*ks*G)*piR4ksG(xi, le));
%}
U_kj_Aux = @(xi, le)(pi*R^2*E*...
    2*(dNu_dx(xi, le).'*dNu_dx(xi, le)) +...
    pi*R^4*E*...
    ((1/4)*2*(dNtetaY_dx(xi, le).'*dNtetaY_dx(xi, le) + dNtetaZ_dx(xi, le).'*dNtetaZ_dx(xi, le))) +...
    pi*R^2*ks*G*...
    2*((NtetaZ(xi, le).' - dNv_dx(xi, le).')*(NtetaZ(xi, le) - dNv_dx(xi, le)) + (NtetaY(xi, le).' + dNw_dx(xi, le).')*(NtetaY(xi, le) + dNw_dx(xi, le))) +...
    pi*R^4*ks*G*...
    ((1/2)*2*...
    (dNtetaX_dx(xi, le).'*dNtetaX_dx(xi, le))));
repositorio.U_kj_Aux = U_kj_Aux;
%ok! 21/12/2021
%ad = 1;

%(6) Matriz Fu (para termos elementares):
U_piR2E_fuj = @(xi, le, uj)(3*du_dx(xi, le, uj)^2*dNu_dx(xi, le).' + du_dx(xi, le, uj)^3*dNu_dx(xi, le).' + dv_dx(xi, le, uj)^3*dNv_dx(xi, le).' + dw_dx(xi, le, uj)^3*dNw_dx(xi, le).' +...
     (dNu_dx(xi, le).'*(dv_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)^2) + (2*dv_dx(xi, le, uj)*dNv_dx(xi, le).' + 2*dw_dx(xi, le, uj)*dNw_dx(xi, le).')*du_dx(xi, le, uj)) +...
     (du_dx(xi, le, uj)*dNu_dx(xi, le).'*dv_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*dNv_dx(xi, le).'*du_dx(xi, le, uj)^2) +...
     (du_dx(xi, le, uj)*dNu_dx(xi, le).'*dw_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*dNw_dx(xi, le).'*du_dx(xi, le, uj)^2) +...
     (dv_dx(xi, le, uj)*dNv_dx(xi, le).'*dw_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*dNw_dx(xi, le).'*dv_dx(xi, le, uj)^2));
%ok! 22/12/2021
U_piR4E_fuj = @(xi, le, uj)(((tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2)/2 +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^2)/2 +...
     (2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*du_dx(xi, le, uj) + dNu_dx(xi, le).'*dtetaX_dx(xi, le, uj)^2)/2 +...
     (2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*du_dx(xi, le, uj) + dNu_dx(xi, le).'*dtetaY_dx(xi, le, uj)^2)*(3/4) +...
     (2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*du_dx(xi, le, uj) + dNu_dx(xi, le).'*dtetaZ_dx(xi, le, uj)^2)*(3/4) +...
     (dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*du_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*dNu_dx(xi, le).'*dtetaX_dx(xi, le, uj)^2)/2 +...
     (dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*du_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*dNu_dx(xi, le).'*dtetaY_dx(xi, le, uj)^2)*(3/4) +...
     (dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*du_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*dNu_dx(xi, le).'*dtetaZ_dx(xi, le, uj)^2)*(3/4) +...
     (dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*dv_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*dNv_dx(xi, le).'*dtetaX_dx(xi, le, uj)^2) +...
     (dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*dv_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*dNv_dx(xi, le).'*dtetaY_dx(xi, le, uj)^2)/4 +...
     (dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*dv_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*dNv_dx(xi, le).'*dtetaZ_dx(xi, le, uj)^2)/4 +...
     (dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*dw_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*dNw_dx(xi, le).'*dtetaX_dx(xi, le, uj)^2) +...
     (dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*dw_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*dNw_dx(xi, le).'*dtetaY_dx(xi, le, uj)^2)/4 +...
     (dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*dw_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*dNw_dx(xi, le).'*dtetaZ_dx(xi, le, uj)^2)/4 -...
     (dNtetaX_dx(xi, le).'*dtetaY_dx(xi, le, uj)*dv_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*dtetaX_dx(xi, le, uj)*dv_dx(xi, le, uj) + dNv_dx(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj))/2 -...
     (dNtetaX_dx(xi, le).'*dtetaZ_dx(xi, le, uj)*dw_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*dtetaX_dx(xi, le, uj)*dw_dx(xi, le, uj) + dNw_dx(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj))/2 -...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj))/2 +...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj))/2 +...
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*du_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*dNu_dx(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)*(3/4) +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^2*du_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*dNu_dx(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)*(3/4) +...
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*dv_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*dNv_dx(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)/4 +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^2*dv_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*dNv_dx(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)/4 +...
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*dw_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*dNw_dx(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)/4 +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^2*dw_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*dNw_dx(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)/4 -...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2*dv_dx(xi, le, uj) + 2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dv_dx(xi, le, uj) + dNv_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2)/2 +...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2*dw_dx(xi, le, uj) + 2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dw_dx(xi, le, uj) + dNw_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2)/2 +...
     (2*tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj) + 2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*du_dx(xi, le, uj) + dNu_dx(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)*(3/4) +...
     (2*tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj) + 2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^2*du_dx(xi, le, uj) + dNu_dx(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)*(3/4) -...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + 2*du_dx(xi, le, uj)*dNu_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj))*(3/4) +...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + 2*du_dx(xi, le, uj)*dNu_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj))*(3/4) -...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + 2*dv_dx(xi, le, uj)*dNv_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj))/4 +...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + 2*dv_dx(xi, le, uj)*dNv_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj))/4 -...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + 2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + dNu_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dv_dx(xi, le, uj) + dNv_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj))/2 -...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + 2*dw_dx(xi, le, uj)*dNw_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj))/4 +...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + 2*dw_dx(xi, le, uj)*dNw_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj))/4 +...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + 2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + dNu_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dw_dx(xi, le, uj) + dNw_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj))/2 -...
     (dNtetaX_dx(xi, le).'*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + dNu_dx(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*dv_dx(xi, le, uj) + dNv_dx(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj))/2 -...
     (dNtetaX_dx(xi, le).'*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + dNu_dx(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*dw_dx(xi, le, uj) + dNw_dx(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj))/2 -...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj) + dNu_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj))*(3/2) +...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj) + dNu_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj))*(3/2)));
%ok! 22/12/2021
U_piR6E_fuj = @(xi, le, uj)((dNtetaX_dx(xi, le).'*dtetaX_dx(xi, le, uj)^3)/3 + (dNtetaY_dx(xi, le).'*dtetaY_dx(xi, le, uj)^3)/8 + (dNtetaZ_dx(xi, le).'*dtetaZ_dx(xi, le, uj)^3)/8 +...
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^4 + 2*dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2)/6 +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^4 + 2*dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^2)/6 +...
     (tetaY(xi, le, uj)^3*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^4 + dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^4)/8 +...
     (tetaZ(xi, le, uj)^3*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^4 + dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^4)/8 +...
     (dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*dtetaY_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*dtetaX_dx(xi, le, uj)^2)/6 +...
     (dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*dtetaZ_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*dtetaX_dx(xi, le, uj)^2)/6 +...
     (dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*dtetaZ_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*dtetaY_dx(xi, le, uj)^2)/8 +...
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*dtetaY_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)/8 +...
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*dtetaZ_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)*(3/8) +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^2*dtetaY_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)*(3/8) +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^2*dtetaZ_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2)/8 +...
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^4 + tetaZ(xi, le, uj)*NtetaZ(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^4 + 2*dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)^2)/8 -...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + 3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^3)/6 -...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)^3 + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj)^3 + 3*dtetaZ_dx(xi, le, uj)^2*dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj))/8 +...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + 3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^3)/6 +...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)^3 + dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)^3 + 3*dtetaY_dx(xi, le, uj)^2*dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj))/8 -...
     (3*tetaY(xi, le, uj)^2*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + 3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)^3*dtetaX_dx(xi, le, uj)^3)/8 +...
     (3*tetaZ(xi, le, uj)^2*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + 3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)^3*dtetaX_dx(xi, le, uj)^3)/8 -...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dtetaY_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + 2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)^2)/8 +...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)^2 + dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)^2 + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)^2 + 2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj))/8 +...
     (2*tetaY(xi, le, uj)*NtetaY(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + NtetaZ(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + 3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^3)/8 -...
     (NtetaY(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + 2*tetaZ(xi, le, uj)*NtetaZ(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + 3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^3)/8 -...
     (NtetaY(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + NtetaZ(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + 2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj))/4);
%ok! 22/12/2021
U_piR2ksG_fuj = @(xi, le, uj)((2*tetaY(xi, le, uj)*NtetaY(xi, le).'*du_dx(xi, le, uj) + tetaY(xi, le, uj)^2*dNu_dx(xi, le).')*2 +...
     (2*tetaZ(xi, le, uj)*NtetaZ(xi, le).'*du_dx(xi, le, uj) + tetaZ(xi, le, uj)^2*dNu_dx(xi, le).')*2 +...
     (2*tetaY(xi, le, uj)*NtetaY(xi, le).'*du_dx(xi, le, uj)^2 + 2*du_dx(xi, le, uj)*dNu_dx(xi, le).'*tetaY(xi, le, uj)^2) +...
     (2*tetaZ(xi, le, uj)*NtetaZ(xi, le).'*du_dx(xi, le, uj)^2 + 2*du_dx(xi, le, uj)*dNu_dx(xi, le).'*tetaZ(xi, le, uj)^2) -...
     (NtetaZ(xi, le).'*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + dNu_dx(xi, le).'*tetaZ(xi, le, uj)*dv_dx(xi, le, uj) + dNv_dx(xi, le).'*tetaZ(xi, le, uj)*du_dx(xi, le, uj))*2 +...
     (NtetaY(xi, le).'*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + dNu_dx(xi, le).'*tetaY(xi, le, uj)*dw_dx(xi, le, uj) + dNw_dx(xi, le).'*tetaY(xi, le, uj)*du_dx(xi, le, uj))*2);
%ok! 22/12/2021
U_piR4ksG_fuj = @(xi, le, uj)((tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2) +...
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaY_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*tetaY(xi, le, uj)^2)/2 +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^2) +...
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*dtetaZ_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)^2)/2 +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaY_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)^2)/2 +...%
     (2*tetaY(xi, le, uj)^3*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^4)/2 +...
     (tetaZ(xi, le, uj)*NtetaZ(xi, le).'*dtetaZ_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le).'*tetaZ(xi, le, uj)^2)/2 +...
     (2*tetaZ(xi, le, uj)^3*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^4)/2 -...
     (NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj))/2 +...
     (NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj))/2 +...%
     (tetaY(xi, le, uj)*NtetaY(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*NtetaZ(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)^2) -...
     (3*tetaY(xi, le, uj)^2*NtetaY(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)^3*dtetaX_dx(xi, le, uj))/2 +...
     (3*tetaZ(xi, le, uj)^2*NtetaZ(xi, le).'*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaZ(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*tetaZ(xi, le, uj)^3*dtetaX_dx(xi, le, uj))/2 +...
     (2*tetaY(xi, le, uj)*NtetaY(xi, le).'*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + NtetaZ(xi, le).'*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj) + dNtetaY_dx(xi, le).'*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj))/2 -...
     (NtetaY(xi, le).'*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + 2*tetaZ(xi, le, uj)*NtetaZ(xi, le).'*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dNtetaX_dx(xi, le).'*tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + dNtetaZ_dx(xi, le).'*tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj))/2);
%ok! 22/12/2021
U_fuj_Aux = @(xi, le, uj)(pi*R^2*E*U_piR2E_fuj(xi, le, uj) +...
    pi*R^4*E*U_piR4E_fuj(xi, le, uj) +...
    pi*R^6*E*U_piR6E_fuj(xi, le, uj) +...
    pi*R^2*ks*G*U_piR2ksG_fuj(xi, le, uj) +...
    pi*R^4*ks*G*U_piR4ksG_fuj(xi, le, uj));

%(6.1) Matriz dFuduT (para termos elementares):
U_piR2E_dfuj = @(xi, le, uj)(3*dNu_dx(xi, le).'*2*du_dx(xi, le, uj)*dNu_dx(xi, le) + dNu_dx(xi, le).'*3*du_dx(xi, le, uj)^2*dNu_dx(xi, le) + dNv_dx(xi, le).'*3*dv_dx(xi, le, uj)^2*dNv_dx(xi, le) + dNw_dx(xi, le).'*3*dw_dx(xi, le, uj)^2*dNw_dx(xi, le) +...
     (dNu_dx(xi, le).'*(2*dv_dx(xi, le, uj)*dNv_dx(xi, le) + 2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     (2*(dNv_dx(xi, le).'*dNv_dx(xi, le)) + 2*(dNw_dx(xi, le).'*dNw_dx(xi, le)))*du_dx(xi, le, uj) + (2*dv_dx(xi, le, uj)*dNv_dx(xi, le).' + 2*dw_dx(xi, le, uj)*dNw_dx(xi, le).')*dNu_dx(xi, le)) +...
     (dNu_dx(xi, le).'*(dNu_dx(xi, le)*dv_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
      dNv_dx(xi, le).'*(dNv_dx(xi, le)*du_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le))) +...
     (dNu_dx(xi, le).'*(dNu_dx(xi, le)*dw_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
      dNw_dx(xi, le).'*(dNw_dx(xi, le)*du_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le))) +...
     (dNv_dx(xi, le).'*(dNv_dx(xi, le)*dw_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
      dNw_dx(xi, le).'*(dNw_dx(xi, le)*dv_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le))));
%ok! 22/12/2021
U_piR4E_dfuj = @(xi, le, uj)((NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)) +...
    dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)))/2 +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)) +...
    dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)))/2 +...
    (dNtetaX_dx(xi, le).'*2*(dNtetaX_dx(xi, le)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNu_dx(xi, le)) +...
    dNu_dx(xi, le).'*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le))/2 +...
    (dNtetaY_dx(xi, le).'*2*(dNtetaY_dx(xi, le)*du_dx(xi, le, uj) + dtetaY_dx(xi, le, uj)*dNu_dx(xi, le)) +...
    dNu_dx(xi, le).'*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le))*(3/4) +...
    (dNtetaZ_dx(xi, le).'*2*(dNtetaZ_dx(xi, le)*du_dx(xi, le, uj) + dtetaZ_dx(xi, le, uj)*dNu_dx(xi, le)) +...
    dNu_dx(xi, le).'*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le))*(3/4) +...
    (dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
    dNu_dx(xi, le).'*(dNu_dx(xi, le)*dtetaX_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/2 +...
    (dNtetaY_dx(xi, le).'*(dNtetaY_dx(xi, le)*du_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
    dNu_dx(xi, le).'*(dNu_dx(xi, le)*dtetaY_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)))*(3/4) +...
    (dNtetaZ_dx(xi, le).'*(dNtetaZ_dx(xi, le)*du_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
    dNu_dx(xi, le).'*(dNu_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)))*(3/4) +...
    (dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
    dNv_dx(xi, le).'*(dNv_dx(xi, le)*dtetaX_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le))) +...
    (dNtetaY_dx(xi, le).'*(dNtetaY_dx(xi, le)*dv_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
    dNv_dx(xi, le).'*(dNv_dx(xi, le)*dtetaY_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)))/4 +... 
    (dNtetaZ_dx(xi, le).'*(dNtetaZ_dx(xi, le)*dv_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
    dNv_dx(xi, le).'*(dNv_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)))/4 +...
    (dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
    dNw_dx(xi, le).'*(dNw_dx(xi, le)*dtetaX_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le))) +...
    (dNtetaY_dx(xi, le).'*(dNtetaY_dx(xi, le)*dw_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
    dNw_dx(xi, le).'*(dNw_dx(xi, le)*dtetaY_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)))/4 +...
    (dNtetaZ_dx(xi, le).'*(dNtetaZ_dx(xi, le)*dw_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
    dNw_dx(xi, le).'*(dNw_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)))/4 -...
    (dNtetaX_dx(xi, le).'*(dNtetaY_dx(xi, le)*dv_dx(xi, le, uj) + dtetaY_dx(xi, le, uj)*dNv_dx(xi, le)) +...
    dNtetaY_dx(xi, le).'*(dNtetaX_dx(xi, le)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNv_dx(xi, le)) +...
    dNv_dx(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)))/2 -...
    (dNtetaX_dx(xi, le).'*(dNtetaZ_dx(xi, le)*dw_dx(xi, le, uj) + dtetaZ_dx(xi, le, uj)*dNw_dx(xi, le)) +...
    dNtetaZ_dx(xi, le).'*(dNtetaX_dx(xi, le)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNw_dx(xi, le)) +...
    dNw_dx(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)))/2 -...
    (NtetaY(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
    dNtetaX_dx(xi, le).'*(NtetaY(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
    dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj) + tetaY(xi, le, uj)*dNtetaX_dx(xi, le)))/2 +...
    (NtetaZ(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
    dNtetaX_dx(xi, le).'*(NtetaZ(xi, le)*dtetaY_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)) +...
    dNtetaY_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)))/2 +...
    (NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*(dNu_dx(xi, le)*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))*(3/4) +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^2*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*(dNu_dx(xi, le)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + du_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))*(3/4) +... 
     (NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2*dv_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dv_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNv_dx(xi, le).'*(dNv_dx(xi, le)*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/4 +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*dv_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dv_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^2*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNv_dx(xi, le).'*(dNv_dx(xi, le)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + dv_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/4 +...
    (NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2*dw_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dw_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNw_dx(xi, le).'*(dNw_dx(xi, le)*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/4 +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*dw_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dw_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^2*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNw_dx(xi, le).'*(dNw_dx(xi, le)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + dw_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/4 -...
    (NtetaZ(xi, le).'*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*dNv_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*NtetaZ(xi, le)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaZ(xi, le, uj)*dNv_dx(xi, le)) +...
     dNv_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/2 +...
     (NtetaY(xi, le).'*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*dNw_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*NtetaY(xi, le)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)*dNw_dx(xi, le)) +...
     dNw_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/2 +...
    (NtetaY(xi, le).'*2*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj) + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj) + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNu_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)^2*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*(2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaY(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))*(3/4) +...
    (NtetaZ(xi, le).'*2*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNu_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^2*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*(2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))*(3/4) -...
    (NtetaY(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaY(xi, le)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dNtetaZ_dx(xi, le)*du_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*2*(dNu_dx(xi, le)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + du_dx(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + du_dx(xi, le, uj)*tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + du_dx(xi, le, uj)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)))*(3/4) +...
     (NtetaZ(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)*du_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaZ(xi, le)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)*du_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*2*(dNu_dx(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + du_dx(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + du_dx(xi, le, uj)*tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + du_dx(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)))*(3/4) -...
    (NtetaY(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaY(xi, le)*dtetaZ_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dNtetaZ_dx(xi, le)*dv_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*dv_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNv_dx(xi, le).'*2*(dNv_dx(xi, le)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dv_dx(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dv_dx(xi, le, uj)*tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + dv_dx(xi, le, uj)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)))/4 +...
    (NtetaZ(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)*dv_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaZ(xi, le)*dtetaY_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)*dv_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dv_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*dv_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*2*dv_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNv_dx(xi, le).'*2*(dNv_dx(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dv_dx(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dv_dx(xi, le, uj)*tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + dv_dx(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)))/4 -...
    (NtetaZ(xi, le).'*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*dNu_dx(xi, le)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*NtetaZ(xi, le)*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaZ(xi, le, uj)*dNu_dx(xi, le)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaZ(xi, le, uj)*du_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNu_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*dv_dx(xi, le, uj) + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dv_dx(xi, le, uj) + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNv_dx(xi, le)) +...
     dNv_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNu_dx(xi, le)))/2 -...
    (NtetaY(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaY(xi, le)*dtetaZ_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dNtetaZ_dx(xi, le)*dw_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*dw_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNw_dx(xi, le).'*2*(dNw_dx(xi, le)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dw_dx(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dw_dx(xi, le, uj)*tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + dw_dx(xi, le, uj)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)))/4 +...
    (NtetaZ(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)*dw_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaZ(xi, le)*dtetaY_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)*dw_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dw_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*dw_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*2*dw_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNw_dx(xi, le).'*2*(dNw_dx(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dw_dx(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dw_dx(xi, le, uj)*tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + dw_dx(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)))/4 +...
     (NtetaY(xi, le).'*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*dNu_dx(xi, le)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*NtetaY(xi, le)*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)*dNu_dx(xi, le)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)*du_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNu_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2*dw_dx(xi, le, uj) + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dw_dx(xi, le, uj) + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNw_dx(xi, le)) +...
     dNw_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2*du_dx(xi, le, uj) + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj) + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNu_dx(xi, le)))/2 -...
    (dNtetaX_dx(xi, le).'*(dNtetaY_dx(xi, le)*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + dtetaY_dx(xi, le, uj)*dNu_dx(xi, le)*dv_dx(xi, le, uj) + dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(dNtetaX_dx(xi, le)*du_dx(xi, le, uj)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNu_dx(xi, le)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNu_dx(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)*dv_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNv_dx(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*dNu_dx(xi, le)))/2 -...
    (dNtetaX_dx(xi, le).'*(dNtetaZ_dx(xi, le)*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + dtetaZ_dx(xi, le, uj)*dNu_dx(xi, le)*dw_dx(xi, le, uj) + dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(dNtetaX_dx(xi, le)*du_dx(xi, le, uj)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNu_dx(xi, le)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNu_dx(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)*dw_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNw_dx(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*dNu_dx(xi, le)))/2 -...
    (NtetaY(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaY(xi, le)*dtetaZ_dx(xi, le, uj)*du_dx(xi, le, uj) + tetaY(xi, le, uj)*dNtetaZ_dx(xi, le)*du_dx(xi, le, uj) + tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj) + tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj) + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)))*(3/2) +...
    (NtetaZ(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)*du_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaZ(xi, le)*dtetaY_dx(xi, le, uj)*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)))*(3/2));
%ok! 22/12/2021
U_piR6E_dfuj = @(xi, le, uj)((dNtetaX_dx(xi, le).'*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le))/3 +...
    (dNtetaY_dx(xi, le).'*3*dtetaY_dx(xi, le, uj)^2*dNtetaY_dx(xi, le))/8 +...
    (dNtetaZ_dx(xi, le).'*3*dtetaZ_dx(xi, le, uj)^2*dNtetaZ_dx(xi, le))/8 +...
    (NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^4 + tetaY(xi, le, uj)*4*dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)^3*2*tetaY(xi, le, uj)*NtetaY(xi, le)))/6 +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^4 + tetaZ(xi, le, uj)*4*dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)^3*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)))/6 +...
    (NtetaY(xi, le).'*(3*tetaY(xi, le, uj)^2*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^4 + tetaY(xi, le, uj)^3*4*dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^4 + dtetaX_dx(xi, le, uj)^3*4*tetaY(xi, le, uj)^3*NtetaY(xi, le)))/8 +...
    (NtetaZ(xi, le).'*(3*tetaZ(xi, le, uj)^2*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^4 + tetaZ(xi, le, uj)^3*4*dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^4 + dtetaX_dx(xi, le, uj)^3*4*tetaZ(xi, le, uj)^3*NtetaZ(xi, le)))/8 +...
    (dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(dNtetaY_dx(xi, le)*dtetaX_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/6 +...
    (dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(dNtetaZ_dx(xi, le)*dtetaX_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/6 +...
    (dNtetaY_dx(xi, le).'*(dNtetaY_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(dNtetaZ_dx(xi, le)*dtetaY_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)))/8 +...
    (NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2*dtetaY_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaY_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(dNtetaY_dx(xi, le)*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/8 +...
    (NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2*dtetaZ_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaZ_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(dNtetaZ_dx(xi, le)*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))*(3/8) +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^2*dtetaY_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaY_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(dNtetaY_dx(xi, le)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))*(3/8) +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^2*dtetaZ_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaZ_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(dNtetaZ_dx(xi, le)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)))/8 +...
    (NtetaY(xi, le).'*(NtetaY(xi, le)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^4 + tetaY(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^4 + tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*4*dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le)) +...
     NtetaZ(xi, le).'*(NtetaZ(xi, le)*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^4 + tetaZ(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^4 + tetaZ(xi, le, uj)*tetaY(xi, le, uj)^2*4*dtetaX_dx(xi, le, uj)^3*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)^3*2*tetaY(xi, le, uj)*NtetaY(xi, le)*tetaZ(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)^3*tetaY(xi, le, uj)^2*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)))/8 -...
    (NtetaY(xi, le).'*(3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^3*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*3*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*tetaY(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*NtetaY(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*tetaY(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^3 + tetaY(xi, le, uj)*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)))/6 -...
    (NtetaY(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)^3 + dtetaX_dx(xi, le, uj)*3*dtetaZ_dx(xi, le, uj)^2*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaY(xi, le)*dtetaZ_dx(xi, le, uj)^3 + tetaY(xi, le, uj)*3*dtetaZ_dx(xi, le, uj)^2*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*3*(2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj) + dtetaZ_dx(xi, le, uj)^2*NtetaY(xi, le)*dtetaX_dx(xi, le, uj) + dtetaZ_dx(xi, le, uj)^2*tetaY(xi, le, uj)*dNtetaX_dx(xi, le)))/8 +...
    (NtetaZ(xi, le).'*(3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^3*dNtetaY_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*3*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*NtetaZ(xi, le)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^3 + tetaZ(xi, le, uj)*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)))/6 +...
    (NtetaZ(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)^3 + dtetaX_dx(xi, le, uj)*3*dtetaY_dx(xi, le, uj)^2*dNtetaY_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaZ(xi, le)*dtetaY_dx(xi, le, uj)^3 + tetaZ(xi, le, uj)*3*dtetaY_dx(xi, le, uj)^2*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*3*(2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj) + dtetaY_dx(xi, le, uj)^2*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj) + dtetaY_dx(xi, le, uj)^2*tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)))/8 -...
    (NtetaY(xi, le).'*3*(2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)^2*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^3*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*3*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*3*tetaY(xi, le, uj)^2*NtetaY(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*tetaY(xi, le, uj)^3*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(3*tetaY(xi, le, uj)^2*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^3 + tetaY(xi, le, uj)^3*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)))/8 +...
    (NtetaZ(xi, le).'*3*(2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + tetaZ(xi, le, uj)^2*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^3*dNtetaY_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*3*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*3*tetaZ(xi, le, uj)^2*NtetaZ(xi, le)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*tetaZ(xi, le, uj)^3*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(3*tetaZ(xi, le, uj)^2*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^3 + tetaZ(xi, le, uj)^3*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)))/8 -...
    (NtetaY(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)^2*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaY(xi, le)*dtetaY_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*dtetaY_dx(xi, le, uj)^2*dNtetaZ_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*2*(dNtetaY_dx(xi, le)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dtetaY_dx(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dtetaY_dx(xi, le, uj)*tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaY_dx(xi, le, uj)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)))/8 +...
    (NtetaZ(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaZ(xi, le)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*2*(dNtetaZ_dx(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dtetaZ_dx(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + dtetaZ_dx(xi, le, uj)*tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + dtetaZ_dx(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)))/8 +...
    (NtetaY(xi, le).'*2*(NtetaY(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^3*dNtetaY_dx(xi, le)) +...
     NtetaZ(xi, le).'*(2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^3*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)^2*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^3*dNtetaY_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*3*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*2*tetaY(xi, le, uj)*NtetaY(xi, le)*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*tetaY(xi, le, uj)^2*NtetaZ(xi, le)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(2*tetaY(xi, le, uj)*NtetaY(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^3 + tetaY(xi, le, uj)^2*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^3 + tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)))/8 -...
    (NtetaY(xi, le).'*(2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)^2*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^3*dNtetaZ_dx(xi, le)) +...
     NtetaZ(xi, le).'*2*(NtetaZ(xi, le)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^3*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)*tetaY(xi, le, uj)*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^3*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*3*(2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*NtetaY(xi, le)*tetaZ(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*tetaY(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)^2*tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^3 + tetaY(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^3 + tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*3*dtetaX_dx(xi, le, uj)^2*dNtetaX_dx(xi, le)))/8 -...
    (NtetaY(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNtetaY_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     NtetaZ(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNtetaY_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*2*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*NtetaY(xi, le)*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)*NtetaZ(xi, le)*dtetaY_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(NtetaY(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)^2*dNtetaY_dx(xi, le)))/4);
%ok! 22/12/2021
U_piR2ksG_dfuj = @(xi, le, uj)((NtetaY(xi, le).'*2*(NtetaY(xi, le)*du_dx(xi, le, uj) + tetaY(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*2*tetaY(xi, le, uj)*NtetaY(xi, le))*2 +...
    (NtetaZ(xi, le).'*2*(NtetaZ(xi, le)*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*2*tetaZ(xi, le, uj)*NtetaZ(xi, le))*2 +...
    (NtetaY(xi, le).'*2*(NtetaY(xi, le)*du_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*2*(dNu_dx(xi, le)*tetaY(xi, le, uj)^2 + du_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le))) +...
    (NtetaZ(xi, le).'*2*(NtetaZ(xi, le)*du_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*du_dx(xi, le, uj)*dNu_dx(xi, le)) +...
     dNu_dx(xi, le).'*2*(dNu_dx(xi, le)*tetaZ(xi, le, uj)^2 + du_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le))) -...
    (NtetaZ(xi, le).'*(dNu_dx(xi, le)*dv_dx(xi, le, uj) + du_dx(xi, le, uj)*dNv_dx(xi, le)) +...
     dNu_dx(xi, le).'*(NtetaZ(xi, le)*dv_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNv_dx(xi, le)) +...
     dNv_dx(xi, le).'*(NtetaZ(xi, le)*du_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNu_dx(xi, le)))*2 +...
    (NtetaY(xi, le).'*(dNu_dx(xi, le)*dw_dx(xi, le, uj) + du_dx(xi, le, uj)*dNw_dx(xi, le)) +...
     dNu_dx(xi, le).'*(NtetaY(xi, le)*dw_dx(xi, le, uj) + tetaY(xi, le, uj)*dNw_dx(xi, le)) +...
     dNw_dx(xi, le).'*(NtetaY(xi, le)*du_dx(xi, le, uj) + tetaY(xi, le, uj)*dNu_dx(xi, le)))*2);
%ok! 22/12/2021
U_piR4ksG_dfuj = @(xi, le, uj)((NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le))) +...
    (NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaY_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(dNtetaY_dx(xi, le)*tetaY(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)))/2 +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le))) +...
    (NtetaY(xi, le).'*(NtetaY(xi, le)*dtetaZ_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(dNtetaZ_dx(xi, le)*tetaY(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)))/2 +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaY_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaY_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(dNtetaY_dx(xi, le)*tetaZ(xi, le, uj)^2 + dtetaY_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)))/2 +...
    (NtetaY(xi, le).'*2*(3*tetaY(xi, le, uj)^2*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaY(xi, le, uj)^3*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^4 + dtetaX_dx(xi, le, uj)*4*tetaY(xi, le, uj)^3*NtetaY(xi, le)))/2 +...
    (NtetaZ(xi, le).'*(NtetaZ(xi, le)*dtetaZ_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*dtetaZ_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(dNtetaZ_dx(xi, le)*tetaZ(xi, le, uj)^2 + dtetaZ_dx(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)))/2 +...
    (NtetaZ(xi, le).'*2*(3*tetaZ(xi, le, uj)^2*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)^3*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaZ(xi, le, uj)^4 + dtetaX_dx(xi, le, uj)*4*tetaZ(xi, le, uj)^3*NtetaZ(xi, le)))/2 -...
    (NtetaY(xi, le).'*(dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaY(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*dtetaX_dx(xi, le, uj) + tetaY(xi, le, uj)*dNtetaX_dx(xi, le)))/2 +...
    (NtetaZ(xi, le).'*(dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaZ(xi, le)*dtetaY_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(NtetaZ(xi, le)*dtetaX_dx(xi, le, uj) + tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)))/2 +...
    (NtetaY(xi, le).'*(NtetaY(xi, le)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)) +...
     NtetaZ(xi, le).'*(NtetaZ(xi, le)*tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)^2 + tetaZ(xi, le, uj)*tetaY(xi, le, uj)^2*2*dtetaX_dx(xi, le, uj)*dNtetaX_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(dNtetaX_dx(xi, le)*tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*2*tetaY(xi, le, uj)*NtetaY(xi, le)*tetaZ(xi, le, uj)^2 + dtetaX_dx(xi, le, uj)*tetaY(xi, le, uj)^2*2*tetaZ(xi, le, uj)*NtetaZ(xi, le))) -...
    (NtetaY(xi, le).'*3*(2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(3*tetaY(xi, le, uj)^2*NtetaY(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)^3*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(3*tetaY(xi, le, uj)^2*NtetaY(xi, le)*dtetaX_dx(xi, le, uj) + tetaY(xi, le, uj)^3*dNtetaX_dx(xi, le)))/2 +...
    (NtetaZ(xi, le).'*3*(2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + tetaZ(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(3*tetaZ(xi, le, uj)^2*NtetaZ(xi, le)*dtetaY_dx(xi, le, uj) + tetaZ(xi, le, uj)^3*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(3*tetaZ(xi, le, uj)^2*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj) + tetaZ(xi, le, uj)^3*dNtetaX_dx(xi, le)))/2 +...
    (NtetaY(xi, le).'*2*(NtetaY(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     NtetaZ(xi, le).'*(2*tetaY(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)^2*dtetaX_dx(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(2*tetaY(xi, le, uj)*NtetaY(xi, le)*tetaZ(xi, le, uj)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)^2*NtetaZ(xi, le)*dtetaY_dx(xi, le, uj) + tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)*dNtetaY_dx(xi, le)) +...
     dNtetaY_dx(xi, le).'*(2*tetaY(xi, le, uj)*NtetaY(xi, le)*tetaZ(xi, le, uj)*dtetaX_dx(xi, le, uj) + tetaY(xi, le, uj)^2*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj) + tetaY(xi, le, uj)^2*tetaZ(xi, le, uj)*dNtetaX_dx(xi, le)))/2 -...
    (NtetaY(xi, le).'*(2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)^2*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     NtetaZ(xi, le).'*2*(NtetaZ(xi, le)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)*NtetaY(xi, le)*dtetaX_dx(xi, le, uj)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)*tetaY(xi, le, uj)*dNtetaX_dx(xi, le)*dtetaZ_dx(xi, le, uj) + tetaZ(xi, le, uj)*tetaY(xi, le, uj)*dtetaX_dx(xi, le, uj)*dNtetaZ_dx(xi, le)) +...
     dNtetaX_dx(xi, le).'*(NtetaY(xi, le)*tetaZ(xi, le, uj)^2*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaZ_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*dNtetaZ_dx(xi, le)) +...
     dNtetaZ_dx(xi, le).'*(NtetaY(xi, le)*tetaZ(xi, le, uj)^2*dtetaX_dx(xi, le, uj) + tetaY(xi, le, uj)*2*tetaZ(xi, le, uj)*NtetaZ(xi, le)*dtetaX_dx(xi, le, uj) + tetaY(xi, le, uj)*tetaZ(xi, le, uj)^2*dNtetaX_dx(xi, le)))/2);
%ok! 22/12/2021
U_dfujdujT_Aux = @(xi, le, uj)(pi*R^2*E*U_piR2E_dfuj(xi, le, uj) +...
    pi*R^4*E*U_piR4E_dfuj(xi, le, uj) +...
    pi*R^6*E*U_piR6E_dfuj(xi, le, uj) +...
    pi*R^2*ks*G*U_piR2ksG_dfuj(xi, le, uj) +...
    pi*R^4*ks*G*U_piR4ksG_dfuj(xi, le, uj));

%(7) Matriz W (força peso, para termos elementares e concentrados):
wj_Aux = @(xi, le, rhoA_ou_M)(2*rhoA_ou_M*g*Nu(xi, le).');
%repositorio.wj_Aux = wj_Aux;
%ok! 01/03/2020

%(23) Matriz W referente à massa m2 (força peso):
wj_m2_Aux = @(psi, le)(2*dm*g*Nu(psi, le).');
%repositorio.wj_m2_Aux = wj_m2_Aux;

%(7) Matriz C (amortecimento, para termos elementares e concentrados):
cjbU_Aux = @(xi, le, bU)(bU*(Nu(xi, le).'*Nu(xi, le)));
cjbTx_Aux = @(xi, le, bTx)(bTx*(NtetaX(xi, le).'*NtetaX(xi, le)));
%cjbV_Aux = @(xi, le, bV)(bV*(Nv(xi, le).'*Nv(xi, le)));
%cjbW_Aux = @(xi, le, bW)(bW*(Nw(xi, le).'*Nw(xi, le)));
%repositorio.wj_Aux = wj_Aux;
%ok! 06/07/2022

%%
%Funções auxiliares, referentes a termos concentrados:
ad_1 = @(nElem)(double(nElem == 1));
repositorio.ad_1 = ad_1;
ad_N0 = @(nElem)(double(nElem == N0));
repositorio.ad_N0 = ad_N0;
ad_N0M1 = @(nElem)(double(nElem == N0+1));
repositorio.ad_N0M1 = ad_N0M1;
ad_N1 = @(nElem)(double(nElem == N1));
repositorio.ad_N1 = ad_N1;
ad_N1M1 = @(nElem)(double(nElem == N1+1));
repositorio.ad_N1M1 = ad_N1M1;
ad_N = @(nElem)(double(nElem == N));
repositorio.ad_N = ad_N;

%%
%Termos concentrados:
%(1) Matriz M1j_c:
%
%Inclusão da inércia interna do motor de potência:
T_M1j_c = @(nElem, le)(ad_1(nElem)*...
    (1/2)*(T_m1j_M3_Aux(0, le) + T_m1j_Motor_Aux(0, le)) +...
    ad_N1(nElem)*...
    (1/2)*(T_m1j_Aux(1, le, M2b, Ip2b, I2) + T_m1j_m2_Aux(1, le)) +...
    ad_N1M1(nElem)*...
    (1/2)*(T_m1j_Aux(0, le, M2b, Ip2b, I2) + T_m1j_m2_Aux(0, le)) +...
    ad_N(nElem)*...
    (1/2)*T_m1j_Aux(1, le, M1, Ip1, I1));
repositorio.T_M1j_c = T_M1j_c;
%}
%{
T_M1j_c = @(nElem, le)(ad_1(nElem)*...
    (1/2)*(T_m1j_M3_Aux(0, le)) +...
    ad_N1(nElem)*...
    (1/2)*(T_m1j_Aux(1, le, M2b, Ip2, I2) + T_m1j_m2_Aux(1, le)) +...
    ad_N1M1(nElem)*...
    (1/2)*(T_m1j_Aux(0, le, M2b, Ip2, I2) + T_m1j_m2_Aux(0, le)) +...
    ad_N(nElem)*...
    (1/2)*T_m1j_Aux(1, le, M1, Ip1, I1));
repositorio.T_M1j_c = T_M1j_c;
%}
%(2) Matriz M2j_c:
T_M2j_c = @(nElem, le, uj)(ad_1(nElem)*...
    (1/2)*(T_m2j_M3_Aux(0, le, uj)) +...
    ad_N1(nElem)*...
    (1/2)*(T_m2j_Aux(1, le, uj, Ip2b) + T_m2j_m2_Aux(1, le, uj)) +...
    ad_N1M1(nElem)*...
    (1/2)*(T_m2j_Aux(0, le, uj, Ip2b) + T_m2j_m2_Aux(0, le, uj)) +...
    ad_N(nElem)*...
    (1/2)*T_m2j_Aux(1, le, uj, Ip1));
repositorio.T_M2j_c = T_M2j_c;

%(2) Matriz M2juppj_c:
T_M2juppj_c = @(nElem, le, uj, uppj)(ad_1(nElem)*...
    (1/2)*T_m2uppj_M3_Aux(0, le, uj, uppj) +...
    ad_N1(nElem)*...
    (1/2)*(T_m2juppj_Aux(1, le, uj, uppj, Ip2b) + T_m2juppj_m2_Aux(1, le, uj, uppj)) +...
    ad_N1M1(nElem)*...
    (1/2)*(T_m2juppj_Aux(0, le, uj, uppj, Ip2b) + T_m2juppj_m2_Aux(0, le, uj, uppj)) +...
    ad_N(nElem)*...
    (1/2)*T_m2juppj_Aux(1, le, uj, uppj, Ip1));
repositorio.T_M2juppj_c = T_M2juppj_c;

%(3) Matriz dM2juppj_dujT_c:
T_dM2juppjdujT_c = @(nElem, le, uj, uppj)(ad_1(nElem)*...
    (1/2)*T_dm2juppjdujT_M3_Aux(0, le, uj, uppj) +...
    ad_N1(nElem)*...
    (1/2)*(T_dm2juppj_dujT_Aux(1, le, uj, uppj, Ip2b) + T_dm2juppjdujT_m2_Aux(1, le, uj, uppj)) +...
    ad_N1M1(nElem)*...
    (1/2)*(T_dm2juppj_dujT_Aux(0, le, uj, uppj, Ip2b) + T_dm2juppjdujT_m2_Aux(0, le, uj, uppj)) +...
    ad_N(nElem)*...
    (1/2)*T_dm2juppj_dujT_Aux(1, le, uj, uppj, Ip1));
repositorio.T_dM2juppj_dujT_c = T_dM2juppjdujT_c;

%(7) Matriz Gj_c:
T_Gj_c = @(nElem, le, uj, upj)(ad_1(nElem)*...
    (1/2)*T_gCj_M3_Aux(0, le, uj, upj) +...
    ad_N1(nElem)*...
    (1/2)*(T_gCj_Aux(1, le, uj, upj, Ip2b) + T_gCj_m2_Aux(1, le, uj, upj)) +...
    ad_N1M1(nElem)*...
    (1/2)*(T_gCj_Aux(0, le, uj, upj, Ip2b) + T_gCj_m2_Aux(0, le, uj, upj)) +...
    ad_N(nElem)*...
    (1/2)*T_gCj_Aux(1, le, uj, upj, Ip1));
repositorio.T_Gj_c = T_Gj_c;

%(8) Matriz dGj_dujT_c:
T_dGjdujT_c = @(nElem, le, uj, upj)(ad_1(nElem)*...
    (1/2)*T_dgCjdujT_M3_Aux(0, le, uj, upj) +...
    ad_N1(nElem)*...
    (1/2)*(T_dgCjdujT_Aux(1, le, upj, Ip2b) + T_dgCjdujT_m2_Aux(1, le, uj, upj)) +...
    ad_N1M1(nElem)*...
    (1/2)*(T_dgCjdujT_Aux(0, le, upj, Ip2b) + T_dgCjdujT_m2_Aux(0, le, uj, upj)) +...
    ad_N(nElem)*...
    (1/2)*T_dgCjdujT_Aux(1, le, upj, Ip1));
repositorio.T_dGj_dujT_c = T_dGjdujT_c;

%(9) Matriz dGj_dupjT_c:
T_dGjdupjT_c = @(nElem, le, uj, upj)(ad_1(nElem)*...
    (1/2)*T_dgCjdupjT_M3_Aux(0, le, uj, upj) +...
    ad_N1(nElem)*...
    (1/2)*(T_dgCjdupjT_Aux(1, le, uj, upj, Ip2b) + T_dgCjdupjT_m2_Aux(1, le, uj, upj)) +...
    ad_N1M1(nElem)*...
    (1/2)*(T_dgCjdupjT_Aux(0, le, uj, upj, Ip2b) + T_dgCjdupjT_m2_Aux(0, le, uj, upj)) +...
    ad_N(nElem)*...
    (1/2)*T_dgCjdupjT_Aux(1, le, uj, upj, Ip1));
repositorio.T_dGj_dupjT_c = T_dGjdupjT_c;

%(10) Matriz Wj_c (força peso, em termos concentrados):
Wj_c = @(nElem, le)(ad_1(nElem)*...
    (1/2)*wj_Aux(0, le, M3pl) +...
    ad_N1(nElem)*...
    (1/2)*(wj_Aux(1, le, M2b) + wj_m2_Aux(1, le)) +...
    ad_N1M1(nElem)*...
    (1/2)*(wj_Aux(0, le, M2b) + wj_m2_Aux(0, le)) +...
    ad_N(nElem)*...
    (1/2)*wj_Aux(1, le, M1));
repositorio.Wj_c = Wj_c;

%{
cjbU_Aux = @(xi, le, bU)(bU*Nu(xi, le).');
cjbTx_Aux = @(xi, le, bTx)(bTx*NtetaX(xi, le).');
cjbV_Aux = @(xi, le, bV)(bV*Nv(xi, le).');
cjbW_Aux = @(xi, le, bW)(bW*Nw(xi, le).');
%}

%(10) Matriz Wj_c (força peso, em termos concentrados):
%{
Cj_c = @(nElem, le)(...
    ad_1(nElem)*...
    (cjbU_Aux(0, le, bUl) + cjbTx_Aux(0, le, bTx1)) +...
    ad_N0(nElem)*...
    (cjbV_Aux(1, le, bV) + cjbW_Aux(1, le, bW)) +...
    ad_N0M1(nElem)*...
    (cjbV_Aux(0, le, bV) + cjbW_Aux(0, le, bW)) +...
    ad_N(nElem)*...
    (cjbU_Aux(1, le, bUNM1) + cjbTx_Aux(1, le, bTxNM1)));
%}
Cj_c = @(nElem, le)(...
    ad_1(nElem)*...
    (cjbU_Aux(0, le, bU1) + cjbTx_Aux(0, le, bTx1)) +...
    ad_N(nElem)*...
    (cjbU_Aux(1, le, bUNM1) + cjbTx_Aux(1, le, bTxNM1)));
repositorio.Cj_c = Cj_c;

%%
%Funções referentes a matrizes elementares:
%(1) Matriz M1j_elem:
fAux = @(xi, le)(T_m1j_Aux(xi, le, rho*A, rho*Jp, rho*J));
T_M1j_elem = @(le)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le)), 0, 1, nGL ));
repositorio.T_M1j_elem = T_M1j_elem;

%(2) Matriz M2j_elem:
fAux = @(xi, le, uj)(T_m2j_Aux(xi, le, uj, rho*Jp));
T_M2j_elem = @(le, uj)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le, uj)), 0, 1, nGL ));
repositorio.T_M2j_elem = T_M2j_elem;

%(2) Matriz M2juppj_elem:
fAux = @(xi, le, uj, uppj)(T_m2juppj_Aux(xi, le, uj, uppj, rho*Jp));
T_M2juppj_elem = @(le, uj, uppj)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le, uj, uppj)), 0, 1, nGL ));
repositorio.T_M2juppj_elem = T_M2juppj_elem;

%(3) Matriz dM2juppj_dujT_elem:
fAux = @(xi, le, uj, uppj)(T_dm2juppj_dujT_Aux(xi, le, uj, uppj, rho*Jp));
T_dM2juppjdujT_elem = @(le, uj, uppj)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le, uj, uppj)), 0, 1, nGL ));
repositorio.T_dM2juppj_dujT_elem = T_dM2juppjdujT_elem;

%(7) Matriz Gj_elem:
fAux = @(xi, le, uj, upj)(T_gCj_Aux(xi, le, uj, upj, rho*Jp));
T_Gj_elem = @(le, uj, upj)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le, uj, upj)), 0, 1, nGL ));
repositorio.T_Gj_elem = T_Gj_elem;

%(8) Matriz dGj_dujT_elem:
fAux = @(xi, le, upj)(T_dgCjdujT_Aux(xi, le, upj, rho*Jp));
T_dGjdujT_elem = @(le, upj)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le, upj)), 0, 1, nGL ));
repositorio.T_dGj_dujT_elem = T_dGjdujT_elem;

%(9) Matriz dGj_dupjT_elem:
fAux = @(xi, le, uj, upj)(T_dgCjdupjT_Aux(xi, le, uj, upj, rho*Jp));
T_dGjdupjT_elem = @(le, uj, upj)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le, uj, upj)), 0, 1, nGL ));
repositorio.T_dGj_dupjT_elem = T_dGjdupjT_elem;

%(10) Matriz Kj_elem (para termos elementares):
fAux = @(xi, le)(U_kj_Aux(xi, le));
U_Kj_elem = @(le)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le)), 0, 1, nGL ));
repositorio.U_Kj_elem = U_Kj_elem;

%(11) Matriz Fuj_elem (para termos elementares):
fAux = @(xi, le, uj)(U_fuj_Aux(xi, le, uj));
U_Fuj_elem = @(le, uj)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le, uj)), 0, 1, nGL ));
repositorio.U_Fuj_elem = U_Fuj_elem;

%(12) Matriz dFuj_dujT_elem (para termos elementares):
fAux = @(xi, le, uj)(U_dfujdujT_Aux(xi, le, uj));
U_dFujdujT_elem = @(le, uj)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le, uj)), 0, 1, nGL ));
repositorio.U_dFuj_dujT_elem = U_dFujdujT_elem;

%(13) Matriz Wj_elem (força peso, para termos elementares):
fAux = @(xi, le)(wj_Aux(xi, le, rho*A));
Wj_elem = @(le)((1/2)*le*...
    faaGaussLegendre( @(xi)(fAux(xi, le)), 0, 1, nGL ));
repositorio.Wj_elem = Wj_elem;

%%
%Matrizes de inércia e rigidez:
[ M1gEF, KgEF ] = fGm1k( argumentos, repositorio );

%%
%Ponto de equilíbrio no modelo em EF:
N = argumentos.N;
Ng = 6*(N + 1);
IdNg = eye(Ng);
SigmaRMaU = zeros(Ng,N+1);
for i = 1:N+1
    nSigRMaU = 6*i-5;
    SigmaRMaU(:,i) = IdNg(:,nSigRMaU);
end
%Atribuição de u1Eq = 0:
SigmaRMauEq = SigmaRMaU(:,2:N+1);

KrM1 = (SigmaRMauEq.'*KgEF)*SigmaRMauEq;
fcEFeq = @(u)(fGfcEFeq( u, argumentos, repositorio ));
fcEFrM1eq = @(urMa)(SigmaRMauEq.'*fcEFeq(SigmaRMauEq*urMa));
%Derivadas:
dfcEFeqduT = @(u)(fGdfcEFduEq( u, argumentos, repositorio ));
dfcEFrM1eqdurM1T = @(urM1)(SigmaRMauEq.'*dfcEFeqduT(SigmaRMauEq*urM1)*SigmaRMauEq);

disp('busca ponto de equilibrio')
%Ponto de equilíbrio:
Eta0 = SigmaRMauEq.'*zeros(Ng,1);
Psi = @(eta)(KrM1*eta + fcEFrM1eq(eta));
dPsidEtaT = @(eta)(KrM1 + dfcEFrM1eqdurM1T(eta));
[ EtaConv ] = f_Newton_Raphson( Eta0, Psi, dPsidEtaT, argumentos );
uTilrM1eq = EtaConv;
uTilEqEF = SigmaRMauEq*uTilrM1eq;
argumentos.uTilEqEF = uTilEqEF;
disp('feito!')

%%
%Atrito

%(3) Modelo de atrito contínuo na origem
mic0 = argumentos.mic0;
w0 = argumentos.w0;
lambdaMi = argumentos.lambdami;
nMi = argumentos.nmi;
%(3.a) Funções adimensionais e auxiliares:
fiAdm = @(nu)(tanh(pi*nu) +...
    lambdaMi*(2*nMi/(2*nMi - 1))./(1 + (1/(2*nMi - 1))*nu.^(2*nMi)));
%{
nu = 0;
ad = fiAdm(nu);
%ok!
%}
dfiAdmdnu = @(nu)(-pi*(tanh(pi*nu)^2 - 1) -...
    (4*lambdaMi*nMi^2*nu^(2*nMi - 1))/(2*nMi + nu^(2*nMi) - 1)^2);
%{
nu = 0;
ad = dfiAdmdnu(nu);
%ok!
%}
d2fiAdmdnu2 = @(nu)(2*pi^2*tanh(pi*nu)*(tanh(pi*nu)^2 - 1) +...
    (16*lambdaMi*nMi^3*nu^(4*nMi - 2))/(2*nMi + nu^(2*nMi) - 1)^3 -...
    (4*lambdaMi*nMi^2*nu^(2*nMi - 2)*(2*nMi - 1))/(2*nMi + nu^(2*nMi) - 1)^2);
%{
nu = 0;
ad = d2fiAdmdnu2(nu);
%ok!
%}
d3fiAdmdnu3 = @(nu)((16*lambdaMi*nMi^3*nu^(4*nMi - 3)*(2*nMi - 1))/(2*nMi + nu^(2*nMi) - 1)^3 -...
    4*pi^3*tanh(pi*nu)^2*(tanh(pi*nu)^2 - 1) -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 3))/(2*nMi + nu^(2*nMi) - 1)^4 -...
    2*pi^3*(tanh(pi*nu)^2 - 1)^2 +...
    (16*lambdaMi*nMi^3*nu^(4*nMi - 3)*(4*nMi - 2))/(2*nMi + nu^(2*nMi) - 1)^3 -...
    (4*lambdaMi*nMi^2*nu^(2*nMi - 3)*(2*nMi - 1)*(2*nMi - 2))/(2*nMi + nu^(2*nMi) - 1)^2);
%{
nu = 0;
ad = d3fiAdmdnu3(nu);
%ok!
%}
d4fiAdmdnu4 = @(nu)(16*pi^4*tanh(pi*nu)*(tanh(pi*nu)^2 - 1)^2 +...
    8*pi^4*tanh(pi*nu)^3*(tanh(pi*nu)^2 - 1) +...
    (768*lambdaMi*nMi^5*nu^(8*nMi - 4))/(2*nMi + nu^(2*nMi) - 1)^5 -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 4)*(2*nMi - 1))/(2*nMi + nu^(2*nMi) - 1)^4 -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 4)*(4*nMi - 2))/(2*nMi + nu^(2*nMi) - 1)^4 -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 4)*(6*nMi - 3))/(2*nMi + nu^(2*nMi) - 1)^4 +...
    (16*lambdaMi*nMi^3*nu^(4*nMi - 4)*(2*nMi - 1)*(2*nMi - 2))/(2*nMi + nu^(2*nMi) - 1)^3 +...
    (16*lambdaMi*nMi^3*nu^(4*nMi - 4)*(2*nMi - 1)*(4*nMi - 3))/(2*nMi + nu^(2*nMi) - 1)^3 +...
    (16*lambdaMi*nMi^3*nu^(4*nMi - 4)*(4*nMi - 2)*(4*nMi - 3))/(2*nMi + nu^(2*nMi) - 1)^3 -...
    (4*lambdaMi*nMi^2*nu^(2*nMi - 4)*(2*nMi - 1)*(2*nMi - 2)*(2*nMi - 3))/(2*nMi + nu^(2*nMi) - 1)^2);
%{
nu = 0;
ad = d4fiAdmdnu4(nu);
%ok!
%}
d5fiAdmdnu5 = @(nu)((768*lambdaMi*nMi^5*nu^(8*nMi - 5)*(2*nMi - 1))/(2*nMi + nu^(2*nMi) - 1)^5 -...
    16*pi^5*tanh(pi*nu)^4*(tanh(pi*nu)^2 - 1) -...
    88*pi^5*tanh(pi*nu)^2*(tanh(pi*nu)^2 - 1)^2 -...
    (7680*lambdaMi*nMi^6*nu^(10*nMi - 5))/(2*nMi + nu^(2*nMi) - 1)^6 -...
    16*pi^5*(tanh(pi*nu)^2 - 1)^3 +...
    (768*lambdaMi*nMi^5*nu^(8*nMi - 5)*(4*nMi - 2))/(2*nMi + nu^(2*nMi) - 1)^5 +...
    (768*lambdaMi*nMi^5*nu^(8*nMi - 5)*(6*nMi - 3))/(2*nMi + nu^(2*nMi) - 1)^5 +...
    (768*lambdaMi*nMi^5*nu^(8*nMi - 5)*(8*nMi - 4))/(2*nMi + nu^(2*nMi) - 1)^5 -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 5)*(2*nMi - 1)*(2*nMi - 2))/(2*nMi + nu^(2*nMi) - 1)^4 -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 5)*(2*nMi - 1)*(4*nMi - 3))/(2*nMi + nu^(2*nMi) - 1)^4 -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 5)*(2*nMi - 1)*(6*nMi - 4))/(2*nMi + nu^(2*nMi) - 1)^4 -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 5)*(4*nMi - 2)*(4*nMi - 3))/(2*nMi + nu^(2*nMi) - 1)^4 -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 5)*(4*nMi - 2)*(6*nMi - 4))/(2*nMi + nu^(2*nMi) - 1)^4 -...
    (96*lambdaMi*nMi^4*nu^(6*nMi - 5)*(6*nMi - 3)*(6*nMi - 4))/(2*nMi + nu^(2*nMi) - 1)^4 +...
    (16*lambdaMi*nMi^3*nu^(4*nMi - 5)*(2*nMi - 1)*(2*nMi - 2)*(2*nMi - 3))/(2*nMi + nu^(2*nMi) - 1)^3 +...
    (16*lambdaMi*nMi^3*nu^(4*nMi - 5)*(2*nMi - 1)*(2*nMi - 2)*(4*nMi - 4))/(2*nMi + nu^(2*nMi) - 1)^3 +...
    (16*lambdaMi*nMi^3*nu^(4*nMi - 5)*(2*nMi - 1)*(4*nMi - 3)*(4*nMi - 4))/(2*nMi + nu^(2*nMi) - 1)^3 +...
    (16*lambdaMi*nMi^3*nu^(4*nMi - 5)*(4*nMi - 2)*(4*nMi - 3)*(4*nMi - 4))/(2*nMi + nu^(2*nMi) - 1)^3 -...
    (4*lambdaMi*nMi^2*nu^(2*nMi - 5)*(2*nMi - 1)*(2*nMi - 2)*(2*nMi - 3)*(2*nMi - 4))/(2*nMi + nu^(2*nMi) - 1)^2);
%{
nu = 0;
ad = d5fiAdmdnu5(nu);
%Obs.: denominador nulo na última parcela, para nu=0 e nMi=2
%}
miAtr = @(tp)(mic0*fiAdm(tp/w0));
repositorio.micAtr = miAtr;
dmiAtrdtp = @(tp)((mic0/w0)*dfiAdmdnu(tp/w0));
repositorio.dmiAtrdtp = dmiAtrdtp;
d2miAtrdtp2 = @(tp)((mic0/w0^2)*d2fiAdmdnu2(tp/w0));
d3miAtrdtp3 = @(tp)((mic0/w0^3)*d3fiAdmdnu3(tp/w0));
d4miAtrdtp4 = @(tp)((mic0/w0^4)*d4fiAdmdnu4(tp/w0));
d5miAtrdtp5 = @(tp)((mic0/w0^5)*d5fiAdmdnu5(tp/w0));
repositorio.miAtr = miAtr;
repositorio.dmiAtrdtp = dmiAtrdtp;
repositorio.d2miAtrdtp2 = d2miAtrdtp2;
repositorio.d3miAtrdtp3 = d3miAtrdtp3;
repositorio.d4miAtrdtp4 = d4miAtrdtp4;
repositorio.d5miAtrdtp5 = d5miAtrdtp5;

%(2) Modelo de atrito descontínuo na origem
%(2.a) Coeficientes de atrito:
mi0 = argumentos.mi0;
mi1 = argumentos.mi1;
mi2 = argumentos.mi2;
beta1dc = argumentos.beta1mi;
beta2dc = argumentos.beta2mi;
miDc = @(tetaXp)((mi0 +...
    mi1*(1 - 2/(1 + exp(beta1dc*abs(tetaXp)))) -...
    mi2*(1 - 2/(1 + exp(beta2dc*abs(tetaXp)))))*...
    sign(tetaXp));
repositorio.miDc = miDc;
dmidtXpDc = @(tetaXp)(mi1*...
    (2*beta1dc*exp(beta1dc*abs(tetaXp))/(1 + exp(beta1dc*abs(tetaXp)))^2) -...
    mi2*...
    (2*beta2dc*exp(beta2dc*abs(tetaXp))/(1 + exp(beta2dc*abs(tetaXp)))^2));
repositorio.dmidtXpDc = dmidtXpDc;

%Modelo de atrito:
%(1) Forças de interaçao no contato de atrito:
uNM1Eq = uTilEqEF(6*(N+1)-5);
uCef = uNM1Eq;
argumentos.uCef = uCef;

%(1.a)Condição de contato:
IipNM1 = @(uNM1)(double(uNM1 >= uCef));
repositorio.IipNM1 = IipNM1;

%(1.b)Força normal:
delta0 = argumentos.delta0;
nFnNM1 = (1/pi)*(1 - uCef/delta0)^(-1);
switch opcaoSignAt
    case 1
        FnNM1 = @(uNM1)(kNM1*(uNM1 - uCef).*double(uNM1 >= uCef));
        dFnNM1duNM1 = @(uNM1)(kNM1*double(uNM1 >= uCef));
    case 2
        FnNM1 = @(uNM1)(kNM1*(uNM1 - uCef).*(tanh(nFnNM1*pi*(uNM1/delta0 - 1)) + 1));
        dFnNM1duNM1 = @(uNM1)(kNM1.*(tanh(nFnNM1*pi*(uNM1/delta0 - 1)) + 1) +...
            kNM1*(uNM1 - uCef)*(-(pi*nFnNM1*(tanh(pi*nFnNM1*(uNM1/delta0 - 1))^2 - 1))/delta0));
    otherwise
        disp('other value')
end
repositorio.FnNM1 = FnNM1;
FnbNM1 = @(ubNM1)(FnNM1(ubNM1 + uNM1Eq));
repositorio.FnbNM1 = FnbNM1;
repositorio.dFnNM1duNM1 = dFnNM1duNM1;

%Funções de atrito no ponto de contato (nó N+1):
%Atrito descontínuo na origem:
TxNM1dc = @(nElem,tetaXpNM1,uNM1)(ad_N(nElem)*miDc(tetaXpNM1)*FnNM1(uNM1)*R_NM1);
repositorio.TxNM1nElemDc = TxNM1dc;
miNM1nElemDc = @(nElem, tetaXpNM1)(ad_N(nElem)*miDc(tetaXpNM1));
repositorio.miNM1nElemDc = miNM1nElemDc;
%Atrito contínuo na origem:
TxNM1c = @(nElem,tetaXpNM1,uNM1)(ad_N(nElem)*miAtr(tetaXpNM1)*FnNM1(uNM1)*R_NM1);
repositorio.TxNM1nElemC = TxNM1c;
miNM1nElemC = @(nElem, tetaXpNM1)(ad_N(nElem)*miAtr(tetaXpNM1));
repositorio.miNM1nElemC = miNM1nElemC;
dmidtXpNM1nElemC = @(nElem, tetaXpNM1)(ad_N(nElem)*...
    dmiAtrdtp(tetaXpNM1));
repositorio.dmidtXpNM1nElemC = dmidtXpNM1nElemC;

%%
%RUBBING
R2 = Dr2/2;
n = (1/pi)*(1 - fg/delta0)^-1;

%Órbita do rotor intermediário:
fuL = @(yL,zL)(sqrt(yL^2 + zL^2)*double(sqrt(yL^2 + zL^2)>eps) +...
    eps*double(sqrt(yL^2 + zL^2)<=eps));
repositorio.fuL = fuL;

%Força normal de contato:
switch opcao_sign
    case 1
        fFn = @(uL)(Kip*(uL - fg)*double(uL>=fg));
    case 2
        fFn = @(uL)(Kip*(uL - fg)*(tanh(n*pi*(uL/delta0 - 1)) + 1));
    otherwise
        disp('other value')
end
repositorio.fFn = fFn;

%Força tangencial de atrito no contato:
%(a) Modelo de atrito contínuo na origem:
miIp0c = argumentos.miIp0c;
v0Ipc = argumentos.v0Ipc;
nmiIpc = argumentos.nmiIpc;
lambdamiIpc = argumentos.lambdamiIpc;
fiIpc = @(nu)(tanh(pi*nu) +...
    lambdamiIpc*((2*nmiIpc)/(2*nmiIpc - 1))*...
    (1 + (1/(2*nmiIpc - 1))*nu^(2*nmiIpc))^-1);
miIpc = @(vCfi)(miIp0c*fiIpc(vCfi/v0Ipc));
repositorio.miIpc = miIpc;
fFtc = @(uL,vC)(miIpc(vC)*fFn(uL));
repositorio.fFtc = fFtc;
%(b) Modelo de atrito descontínuo na origem:
miIp0dc = argumentos.mi0ip;
miIp1dc = argumentos.mi1ip;
miIp2dc = argumentos.mi2ip;
beta1miIpdc = argumentos.beta1miIp;
beta2miIpdc = argumentos.beta2miIp;
nS = 5;
signS = @(nu)(tanh(nS*pi*nu));
dsignSdnu = @(nu)(-pi*nS*(tanh(pi*nS*nu)^2 - 1));
switch opcao_sign
    case 1
        miIpdc = @(vCfi)(sign(vCfi)*...
            (miIp0dc +...
            miIp1dc*(1 - 2*(1 + exp(beta1miIpdc*abs(vCfi)))^-1) +...
            miIp2dc*(1 - 2*(1 + exp(beta2miIpdc*abs(vCfi)))^-1)));
    case 2
        miIpdc = @(vCfi)(signS(vCfi)*...
            (miIp0dc +...
            miIp1dc*(1 - 2*(1 + exp(beta1miIpdc*abs(vCfi)))^-1) +...
            miIp2dc*(1 - 2*(1 + exp(beta2miIpdc*abs(vCfi)))^-1)));
    otherwise
        disp('other value')
end
fFtdc = @(uL,vC)(miIpdc(vC)*fFn(uL));
repositorio.fFtdc = fFtdc;
repositorio.miIpdc = miIpdc;

%Velocidade parcial de contato:
Alc = @(yL,zL)(...
    [1 + (R2/fuL(yL,zL))*(zL/fuL(yL,zL))^2, -yL*zL*R2/fuL(yL,zL)^3; 
    -zL*yL*R2/fuL(yL,zL)^3, 1 + (R2/fuL(yL,zL))*(yL/fuL(yL,zL))^2]);
AvCfi = @(yL,zL)([R2, zeros(1,2); zeros(2,1), Alc(yL,zL)]);
%{
fuCp = @(yL,zL,uL,yLp,zLp)(Alc(yL,zL,uL)*[yLp;zLp]);
fuTilHatfiL = @(fiL)([-sin(fiL); cos(fiL)]);
ffiL = @(yL,zL)(atan2(zL,yL));
fvCfi = @(yL,zL,teta2p,yLp,zLp)(fuTilHatfiL(ffiL(yL,zL)).'*...
    fuCp(yL,zL,fuL(yL,zL),yLp,zLp) +...
    R2*teta2p);
%}
%(a) Versor unitário na direção tangencial:
fuTilHatfiL = @(yL,zL)([-zL/fuL(yL,zL); yL/fuL(yL,zL)]);
%(b) Velocidade parcial do ponto de contato:
fvCfi = @(yL,zL,teta2p,yLp,zLp)([1, fuTilHatfiL(yL,zL).']*AvCfi(yL,zL)*[teta2p; yLp; zLp]);
repositorio.fvCfi = fvCfi;

%Forças e torque de interação no contato:
%(a) Modelo de atrito contínuo na origem:
fFyc = @(yL,zL,teta2p,yLp,zLp)(-fFn(fuL(yL,zL))*(yL/fuL(yL,zL)) +...
    fFtc(fuL(yL,zL),fvCfi(yL,zL,teta2p,yLp,zLp))*(zL/fuL(yL,zL)));
repositorio.fFyRubc = fFyc;
fFzc = @(yL,zL,teta2p,yLp,zLp)(-fFn(fuL(yL,zL))*(zL/fuL(yL,zL)) -...
    fFtc(fuL(yL,zL),fvCfi(yL,zL,teta2p,yLp,zLp))*(yL/fuL(yL,zL)));
repositorio.fFzRubc = fFzc;
fT2c = @(yL,zL,teta2p,yLp,zLp)(-miIpc(fvCfi(yL,zL,teta2p,yLp,zLp))*...
    fFn(fuL(yL,zL))*(R2 + fg));
repositorio.fT2cRub = fT2c;
%(b) Modelo de atrito descontínuo na origem:
fFydc = @(yL,zL,teta2p,yLp,zLp)(-fFn(fuL(yL,zL))*(yL/fuL(yL,zL)) +...
    fFtdc(fuL(yL,zL),fvCfi(yL,zL,teta2p,yLp,zLp))*(zL/fuL(yL,zL)));
repositorio.fFyRubdc = fFydc;
fFzdc = @(yL,zL,teta2p,yLp,zLp)(-fFn(fuL(yL,zL))*(zL/fuL(yL,zL)) -...
    fFtdc(fuL(yL,zL),fvCfi(yL,zL,teta2p,yLp,zLp))*(yL/fuL(yL,zL)));
repositorio.fFzRubdc = fFzdc;
fT2dc = @(yL,zL,teta2p,yLp,zLp)(-miIpdc(fvCfi(yL,zL,teta2p,yLp,zLp))*...
    fFn(fuL(yL,zL))*(R2 + fg));
repositorio.fT2dcRub = fT2dc;

%%
%Rubbing (DERIVADAS):
inc_dsignS = argumentos.inc_dsignS;

%Força normal de contato:
switch opcao_sign
    case 1
        fdFnduL = @(uL)(Kip*double(uL>=fg));
    case 2
        fdFnduL = @(uL)(Kip*(tanh(n*pi*(uL/delta0 - 1)) + 1) +...
            inc_dsignS*Kip*(fg - uL)*(pi*n/delta0)*(tanh(pi*n*(uL/delta0 - 1))^2 - 1));
    otherwise
        disp('other value')
end
repositorio.dFnduL = fdFnduL;

fduLdyL = @(yL,zL)(yL/fuL(yL,zL));
repositorio.fduLdyL = fduLdyL;
fduLdzL = @(yL,zL)(zL/fuL(yL,zL));
repositorio.fduLdzL = fduLdzL;
fdyLuLpwm1dyL = @(yL,zL)((1/fuL(yL,zL))*(1 - (yL/fuL(yL,zL))^2));
repositorio.fdyLuLpwm1dyL = fdyLuLpwm1dyL;
fdyLuLpwm1dzL = @(yL,zL)(-yL*zL/(fuL(yL,zL))^3);
repositorio.fdyLuLpwm1dzL = fdyLuLpwm1dzL;
fdzLuLpwm1dzL = @(yL,zL)((1/fuL(yL,zL))*(1 - (zL/fuL(yL,zL))^2));
repositorio.fdzLuLpwm1dzL = fdzLuLpwm1dzL;
fdzLuLpwm1dyL = @(yL,zL)(-zL*yL/(fuL(yL,zL))^3);
repositorio.fdzLuLpwm1dyL = fdzLuLpwm1dyL;

%Modelo de atrito contínuo na origem:
dfiIpcdvCfi = @(nu)(- pi*(tanh(pi*nu)^2 - 1) -...
    (4*lambdamiIpc*nmiIpc^2*nu^(2*nmiIpc - 1))/(2*nmiIpc + nu^(2*nmiIpc) - 1)^2);
dmiIpcdvCfi = @(vCfi)(miIp0c*(1/v0Ipc)*dfiIpcdvCfi(vCfi/v0Ipc));
repositorio.dmiIpcdvCfi = dmiIpcdvCfi;

%Modelo de atrito descontínuo na origem:
switch opcao_sign
    case 1
        dmiIpdcdvCfi = @(vCfi)(miIp1dc*...
            (2*beta1miIpdc*exp(beta1miIpdc*abs(vCfi))/(1 + exp(beta1miIpdc*abs(vCfi)))^2) +...
            miIp2dc*...
            (2*beta2miIpdc*exp(beta2miIpdc*abs(vCfi))/(1 + exp(beta2miIpdc*abs(vCfi)))^2));
    case 2
        dmiIpdcdvCfi = @(vCfi)(miIp1dc*...
            (2*beta1miIpdc*exp(beta1miIpdc*abs(vCfi))/(1 + exp(beta1miIpdc*abs(vCfi)))^2) +...
            miIp2dc*...
            (2*beta2miIpdc*exp(beta2miIpdc*abs(vCfi))/(1 + exp(beta2miIpdc*abs(vCfi)))^2) +...
            inc_dsignS*dsignSdnu(vCfi)*...
            (miIp0dc +...
            miIp1dc*(1 - 2*(1 + exp(beta1miIpdc*abs(vCfi)))^-1) +...
            miIp2dc*(1 - 2*(1 + exp(beta2miIpdc*abs(vCfi)))^-1)));
    otherwise
        disp('other value')
end
repositorio.dmiIpdcdvCfi = dmiIpdcdvCfi;

duTilHatfiLdyL = @(yL,zL)([(yL*zL)/fuL(yL,zL)^3; zL^2/fuL(yL,zL)^3]);
dAlcdyL = @(yL,zL)([-(3*R2*yL*zL^2)/fuL(yL,zL)^5, -(R2*zL*(fuL(yL,zL)^2 - 3*yL^2))/fuL(yL,zL)^5; 
    -(R2*zL*(fuL(yL,zL)^2 - 3*yL^2))/fuL(yL,zL)^5, (R2*yL*(2*fuL(yL,zL)^2 - 3*yL^2))/fuL(yL,zL)^5]);
dAvCfidyL = @(yL,zL)([R2, zeros(1,2); zeros(2,1), dAlcdyL(yL,zL)]);
dvCfidyL = @(yL,zL,teta2p,yLp,zLp)(([0, duTilHatfiLdyL(yL,zL).']*AvCfi(yL,zL) +...
    [0, fuTilHatfiL(yL,zL).']*dAvCfidyL(yL,zL))*...
    [teta2p; yLp; zLp]);
repositorio.dvCfidyL = dvCfidyL;
duTilHatfiLdzL = @(yL,zL)([-yL^2/fuL(yL,zL)^3; -(yL*zL)/fuL(yL,zL)^3]);
dAlcdzL = @(yL,zL)([(R2*zL*(2*fuL(yL,zL)^2 - 3*zL^2))/fuL(yL,zL)^5, -(R2*yL*(fuL(yL,zL)^2 - 3*zL^2))/fuL(yL,zL)^5;
    -(R2*yL*(fuL(yL,zL)^2 - 3*zL^2))/fuL(yL,zL)^5, -(3*R2*yL^2*zL)/fuL(yL,zL)^5]);
dAvCfidzL = @(yL,zL)([R2, zeros(1,2); zeros(2,1), dAlcdzL(yL,zL)]);
dvCfidzL = @(yL,zL,teta2p,yLp,zLp)(([0, duTilHatfiLdzL(yL,zL).']*AvCfi(yL,zL) +...
    [0, fuTilHatfiL(yL,zL).']*dAvCfidzL(yL,zL))*...
    [teta2p; yLp; zLp]);
repositorio.dvCfidzL = dvCfidzL;

fdvCfidteta2p = @(yL,zL)([1, fuTilHatfiL(yL,zL).']*AvCfi(yL,zL)*[1; 0; 0]);
repositorio.fdvCfidteta2p = fdvCfidteta2p;
fdvCfidyLp = @(yL,zL)([1, fuTilHatfiL(yL,zL).']*AvCfi(yL,zL)*[0; 1; 0]);
repositorio.fdvCfidyLp = fdvCfidyLp;
fdvCfidzLp = @(yL,zL)([1, fuTilHatfiL(yL,zL).']*AvCfi(yL,zL)*[0; 0; 1]);
repositorio.fdvCfidzLp = fdvCfidzLp;

%%

%Rigidez em torno do ponto de equilíbrio:
KgEFb = KgEF + fGdfuduT( uTilEqEF, argumentos, repositorio );
SigmaReF = [IdNg(:,1),IdNg(:,6),IdNg(:,7:6*N),IdNg(:,6*(N+1)-5),IdNg(:,6*(N+1))];
argumentos.SigmaReF = SigmaReF;
M1restr = SigmaReF.'*M1gEF*SigmaReF;
%Krestr = SigmaReF.'*KgEF*SigmaReF;
KbRestr = SigmaReF.'*KgEFb*SigmaReF;

[ PtX, sigTiltX, Pu, sigTilu, Pvw, sigTilvw, Abvt, Abvl, info ] =...
    fModMMod( M1restr, KbRestr, argumentos );
%Primeiros modos torsionais:
argumentos.PtX = PtX;
%Primeiras frequências torsionais:
argumentos.sigTiltX = sigTiltX;
%Primeiros modos longitudinais:
argumentos.Pu = Pu;
%Primeiras frequências longitudinais:
argumentos.sigTilu = sigTilu;
%Modos reversos:
argumentos.Pvw = Pvw;
%Frequências dos modos reversos:
argumentos.sigTilvw = sigTilvw;
%Posição do modo PtX0 em Abvt (matriz de modos já ordenados):
jPtX0 = info.jPtX0;
argumentos.jPtX0 = jPtX0;
%Posição do modo PtX1 em Abvt:
jPtX1 = info.jPtX1;
argumentos.jPtX1 = jPtX1;
%Posição do modo PtX2 em Abvt:
jPtX2 = info.jPtX2;
argumentos.jPtX2 = jPtX2;
%Posição do modo Pu0 em Abvt:
jPu0 = info.jPu0;
argumentos.jPu0 = jPu0;
%Posição do modo Pu1 em Abvt:
jPu1 = info.jPu1;
argumentos.jPu1 = jPu1;
%Posição do modo Pu2 em Abvt:
jPu2 = info.jPu2;
argumentos.jPu2 = jPu2;
%Posição do modo Pv em Abvt:
jPv = info.jPv;
argumentos.jPv = jPv;
%Posição do modo Pw em Abvt:
jPw = info.jPw;
argumentos.jPw = jPw;
%Frequências do sistema em Hz:
wEF = sqrt(Abvl);
%freqEF = wEF/(2*pi);

%%
disp('Matriz de amortecimento')
%Matriz de amortecimento:
%(a) Amortecimento estrutural:
nSig = length(sigTiltX);
wRmin = wEF(jPtX1,1); %rad/s
wRmax = max(wEF); %rad/s
qsiMax = 1; %Valor máximo dos coeficientes de amortecimento
if nSig<3
    %Matriz de amortecimento:
    %Obs: 
    %{
    (1) C = alfa*M1 + beta*K
    (2) alfa e beta foram escolhidos de modo que todos os modos fossem subamort:
       (a) alfa = 2*(wMin*wMax)/(wMin + wMax)
       (b) beta = 2/(wMin + wMax)
       (c) wMin e wMax são tais que f(wMin) = f(wMax) = 1
       (d) f(w) = (1/2)*(alfa/w + beta*w)
       (e) qsiMin: menor coeficiente de amortecimento nominal
    (3) Parâmetros para determinação de alfa e beta: qsiMin, wRmin, wRmax
       (a) wRmin: menor frequência natural do sistema
       (b) wRmax: maior frequência natural do sistema
       (c) wMin < wRmin <= w <= wRmax < wMax
    (4) Sequência de cálculo:
       (a) determinação de qsiMin, tal que 0 <= qsiMin <= qsiMinMax
       (b) deltaQsi = qsi*(1 + sqrt(1 - qsi^2))^-1
       (c) deltaQsi0 = wRmin/wRmax
       (d) deltaQsiMax = sqrt(wRmin/wRmax)
       (e) wQsi: wRmin <= wQsi <= wRmax, se 0 <= qsiMin < qsiMin0
           wQsi: wRmax*deltaQsi <= wQsi <= wRmin/deltaQsi, se qsiMin0 <= qsiMin <= qsiMinMax
    %}
    argumentos.qsiMax = qsiMax;
    deltaQsi0 = wRmin/wRmax;
    deltaQsiMax = sqrt(wRmin/wRmax);
    qsiMin0 = 2*qsiMax*(deltaQsi0 + deltaQsi0^-1)^-1;
    qsiMinMax = 2*qsiMax*(deltaQsiMax + deltaQsiMax^-1)^-1;
    sigQsi = 0.5; %Condição: 0 <= sigQsi <= 1
    %{
    antes_de_QsiMin0 = 1;
    qsiMin = sigQsi*qsiMin0*double(antes_de_QsiMin0) +...
        ((1 - sigQsi)*qsiMin0 + sigQsi*qsiMinMax)*double(~antes_de_QsiMin0);
    %Obs.: Escolha de qsiMin, especificando previamente se menor ou maior que
    %qsiMin0
    %}
    %
    qsiMin = sigQsi*qsiMinMax;
    %Obs.: Escolha de qsiMin, especificando apenas um valor entre 0 e qsiMinMax
    %}
    argumentos.qsiMin = qsiMin;
    deltaQsi = qsiMin*(qsiMax + sqrt(qsiMax^2 - qsiMin^2))^-1;
    sigWqsi = 0.1;
    wQsiMin = (wRmin*(1-sigWqsi) + wRmax*sigWqsi)*...
        double(qsiMin<qsiMin0) +...
        (deltaQsi*wRmax*(1-sigWqsi) + (wRmin/deltaQsi)*sigWqsi)*...
        double(qsiMin>=qsiMin0);
    argumentos.wQsiMin = wQsiMin; %Freq nominal associada a qsiMin
    wMin = deltaQsi*wQsiMin;
    wMax = wQsiMin/deltaQsi;
    alfaEF = 2*qsiMax*(wMin*wMax)/(wMin + wMax);
    betaEF = 2*qsiMax/(wMin + wMax);
    deltaMin = log10(wRmin) - log10(wMin);
    argumentos.deltaMin = deltaMin;
    deltaMax = log10(wMax) - log10(wRmax);
    argumentos.deltaMax = deltaMax;
    %(a) Amortecimento estrutural:
    CgEFestr = alfaEF*M1gEF + betaEF*KgEFb;
    wNatTil = freqNatKbw;
    psiAmort = (1/2)*(alfaEF./wNatTil + betaEF*wNatTil);
    argumentos.psiAmort = psiAmort;
else
    %{
    deltaMax = 0.1;
    wMax = wRmax*10^deltaMax;
    betaEF = 2*qsiMax/wMax;
    %}
    betaEF = 0;
    %betaEF = 0.5;
    %(a) Amortecimento estrutural:
    CgEFestr = betaEF*KgEFb;
    wNatTil = wEF;
    psiAmort = (1/2)*(betaEF*wNatTil);
    argumentos.psiAmort = psiAmort;
end
%(b) Amortecimento concentrado:
[ CgEFconc ] = fGcAmort( argumentos, repositorio );
%(c) Amortecimento total:
adCconc = 1; %(i) adCx == 0: amort nulo; (ii) adCx == 1: amort não nulo
adCestr = 1;
CgEF = adCestr*CgEFestr + adCconc*CgEFconc;
argumentos.CgEF = CgEF;
%Crestr = SigmaReF.'*CgEF*SigmaReF;

%Bef = [IdNg(:,6*1),IdNg(:,6*1-5)];
%Br = SigmaReF.'*Bef;

%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Vetor fEF(u,up,upp):
%(1) Modelo contínuo de atrito:
fcEF = @(u,up,upp)(fGfcEF( u, up, upp, argumentos, repositorio ));
repositorio.fcEF = fcEF;
%(2) Modelo descontínuo de atrito:
fdcEF = @(u,up,upp)(fGfdcEF( u, up, upp, argumentos, repositorio ));
repositorio.fdcEF = fdcEF;

%Força peso sobressalente:
[ Wef ] = fGw( argumentos, repositorio );
[ Fu ] = fGfu( uTilEqEF, argumentos, repositorio );
Wsb = Wef - KgEF*uTilEqEF - Fu;
%Wsbr = SigmaReF.'*Wsb;

%Definição de variáveis e funções, em torno do ponto de equilíbrio:
ub0 = zeros(Ng,1); ubp0 = zeros(Ng,1); ubpp0 = zeros(Ng,1);
%(1) Modelo contínuo de atrito:
fcEFb = @(ub,ubp,ubpp)(KgEF*uTilEqEF + fcEF(ub + uTilEqEF,ubp,ubpp) + Wsb);
fc0 = fcEFb(ub0,ubp0,ubpp0);
fcEFb = @(ub,ubp,ubpp)(fcEFb(ub,ubp,ubpp) - fc0);
repositorio.fcEFb = fcEFb;
%fcEFbr = @(ubr,ubpr,ubppr)(SigmaReF.'*fcEFb(SigmaReF*ubr,SigmaReF*ubpr,SigmaReF*ubppr));
%(2) Modelo descontínuo de atrito:
fdcEFb = @(ub,ubp,ubpp)(KgEF*uTilEqEF + fdcEF(ub + uTilEqEF,ubp,ubpp) + Wsb);
fdc0 = fdcEFb(ub0,ubp0,ubpp0);
fdcEFb = @(ub,ubp,ubpp)(fdcEFb(ub,ubp,ubpp) - fdc0);
repositorio.fdcEFb = fdcEFb;
%fdcEFbr = @(ubr,ubpr,ubppr)(SigmaReF.'*fdcEFb(SigmaReF*ubr,SigmaReF*ubpr,SigmaReF*ubppr));

%Derivadas:
dudubT = IdNg;
dupdubpT = IdNg;
duppdubppT = IdNg;
%(1) Modelo contínuo de atrito:
dfcEFduT = @(u,up,upp)(fGdfcEFdu( u, up, upp, argumentos, repositorio ));
dfcEFbdubT = @(ub,ubp,ubpp)(dfcEFduT(ub + uTilEqEF,ubp,ubpp)*dudubT);
repositorio.dfcEFbdubT = dfcEFbdubT;
%{
ub0 = zeros(Ng,1);
ubp0 = zeros(Ng,1);
ubpp0 = zeros(Ng,1);
ad = dfcEFbdubT(ub0,ubp0,ubpp0);
%}
%dfcEFbrdubrT = @(ubr,ubpr,ubppr)(...
%    SigmaReF.'*dfcEFbdubT(SigmaReF*ubr,SigmaReF*ubpr,SigmaReF*ubppr)*SigmaReF);
dfcEFdupT = @(u,up)(fGdfcEFdup( u, up, argumentos, repositorio ));
dfcEFbdubpT = @(ub,ubp)(dfcEFdupT(ub + uTilEqEF,ubp)*dupdubpT);
repositorio.dfcEFbdubpT = dfcEFbdubpT;
%dfcEFbrdubprT = @(ubr,ubpr)(...
%    SigmaReF.'*dfcEFbdubpT(SigmaReF*ubr,SigmaReF*ubpr)*SigmaReF);
%(2) Modelo descontínuo de atrito:
dfdcEFduT = @(u,up,upp)(fGdfdcEFdu( u, up, upp, argumentos, repositorio ));
dfdcEFbdubT = @(ub,ubp,ubpp)(dfdcEFduT(ub + uTilEqEF,ubp,ubpp)*dudubT);
repositorio.dfdcEFbdubT = dfdcEFbdubT;
%dfdcEFbrdubrT = @(ubr,ubpr,ubppr)(...
%    SigmaReF.'*dfdcEFbdubT(SigmaReF*ubr,SigmaReF*ubpr,SigmaReF*ubppr)*SigmaReF);
dfdcEFdupT = @(u,up)(fGdfdcEFdup( u, up, argumentos, repositorio ));
dfdcEFbdubpT = @(ub,ubp)(dfdcEFdupT(ub + uTilEqEF,ubp)*dupdubpT);
repositorio.dfdcEFbdubpT = dfdcEFbdubpT;
%dfdcEFbrdubprT = @(ubr,ubpr)(...
%    SigmaReF.'*dfdcEFbdubpT(SigmaReF*ubr,SigmaReF*ubpr)*SigmaReF);
%(3) Derivada em relação à aceleração:
dfEFduppT = @(u)(fGdfEFdupp( u, argumentos, repositorio ));
dfEFbdubppT = @(ub)(dfEFduppT(ub + uTilEqEF)*duppdubppT);
%repositorio.dfEFbdubppT = dfEFbdubppT;
%dfEFbrdubpprT = @(ubr)(...
%    SigmaReF.'*dfEFbdubppT(SigmaReF*ubr)*SigmaReF);

%%
%Vetor fEFaprox(u,up,upp):
indG = 0; 
argumentos.indG = indG;
%Obs.: 
%indG = 1: inclusão da função G em fc[d]EFaprox
%indG = 0: retirada da função G em fc[d]EFaprox
%(1) Modelo contínuo de atrito:
%Obs.: foram retirados os termos M2upp e FRubb
%fcEFaprox = @(u,up)(fGfcEFaprox( u, up, argumentos, repositorio ));
%repositorio.fcEFaprox = fcEFaprox;
%(2) Modelo descontínuo de atrito:
%fdcEFaprox = @(u,up)(fGfdcEFaprox( u, up, argumentos, repositorio ));
%repositorio.fdcEFaprox = fdcEFaprox;
%Definição de variáveis e funções, em torno do ponto de equilíbrio:
%(1) Modelo contínuo de atrito:
%fcEFbAprox = @(ub,ubp)(KgEF*uTilEqEF + fcEFaprox(ub + uTilEqEF,ubp));
%repositorio.fcEFbAprox = fcEFbAprox;
%fcEFbAtr = @(ub,ubp)(fGfcEFbAtr( ub, ubp, argumentos, repositorio ));
%repositorio.fcEFbAtr = fcEFbAtr;
%(2) Modelo descontínuo de atrito:
%fdcEFbAprox = @(ub,ubp)(KgEF*uTilEqEF + fdcEFaprox(ub + uTilEqEF,ubp));
%repositorio.fdcEFbAprox = fdcEFbAprox;
%fdcEFbAtr = @(ub,ubp)(fGfdcEFbAtr( ub, ubp, argumentos, repositorio ));
%repositorio.fdcEFbAtr = fdcEFbAtr;

%(1a) Aproximação:
%dfcEFduTaprox = @(u,up)(fGdfcEFduAprox( u, up, argumentos, repositorio ));
%dfcEFbdubTaprox = @(ub,ubp)(dfcEFduTaprox(ub + uTilEqEF,ubp)*dudubT);
%repositorio.dfcEFbdubTaprox = dfcEFbdubTaprox;
%dfcEFdupTaprox = @(u,up)(fGdfcEFdupAprox( u, up, argumentos, repositorio ));
%dfcEFbdubpTaprox = @(ub,ubp)(dfcEFdupTaprox(ub + uTilEqEF,ubp)*dupdubpT);
%repositorio.dfcEFbdubpTaprox = dfcEFbdubpTaprox;
%dfcEFdubTAtr = @(ub,ubp)(fGdfcEFdubAtr( ub, ubp, argumentos, repositorio ));
%repositorio.dfcEFdubTAtr = dfcEFdubTAtr;
%dfcEFdubpTAtr = @(ub,ubp)(fGdfcEFdubpAtr( ub, ubp, argumentos, repositorio ));
%repositorio.dfcEFdubpTAtr = dfcEFdubpTAtr;

%(2a) Aproximação:
%dfdcEFduTaprox = @(u,up)(fGdfdcEFduAprox( u, up, argumentos, repositorio ));
%dfdcEFbdubTaprox = @(ub,ubp)(dfdcEFduTaprox(ub + uTilEqEF,ubp)*dudubT);
%repositorio.dfdcEFbdubTaprox = dfdcEFbdubTaprox;
%dfdcEFdupTaprox = @(u,up)(fGdfdcEFdupAprox( u, up, argumentos, repositorio ));
%dfdcEFbdubpTaprox = @(ub,ubp)(dfdcEFdupTaprox(ub + uTilEqEF,ubp)*dupdubpT);
%repositorio.dfdcEFbdubpTaprox = dfdcEFbdubpTaprox;
%dfdcEFdubTAtr = @(ub,ubp)(fGdfdcEFdubAtr( ub, ubp, argumentos, repositorio ));
%repositorio.dfdcEFdubTAtr = dfdcEFdubTAtr;
%dfdcEFdubpTAtr = @(ub,ubp)(fGdfdcEFdubpAtr( ub, ubp, argumentos, repositorio ));
%repositorio.dfdcEFdubpTAtr = dfdcEFdubpTAtr;

%%
%Pré-integração:
gamaNmk = argumentos.gama_newmark;
betaNmk = argumentos.beta_newmark;
alfa1Nmk = @(dtnM1)(gamaNmk*(betaNmk*dtnM1)^-1);
alfa2Nmk = @(dtnM1)((betaNmk*dtnM1^2)^-1);
fi1Nmk = @(dtnM1,un,upn,uppn)(-alfa1Nmk(dtnM1)*un +...
    (1 - gamaNmk*betaNmk^-1)*upn +...
    (1 - gamaNmk*(2*betaNmk)^-1)*dtnM1*uppn);
%repositorio.fi1Nmk = fi1Nmk;
fi2Nmk = @(dtnM1,un,upn,uppn)(-alfa2Nmk(dtnM1)*un -...
    (betaNmk*dtnM1)^-1*upn +...
    (1 - (2*betaNmk)^-1)*uppn);
%repositorio.fi2Nmk = fi2Nmk;
fupnM1 = @(dtnM1,unM1,un,upn,uppn)(alfa1Nmk(dtnM1)*unM1 +...
    fi1Nmk(dtnM1,un,upn,uppn));
%repositorio.fupnM1 = fupnM1;
fuppnM1 = @(dtnM1,unM1,un,upn,uppn)(alfa2Nmk(dtnM1)*unM1 +...
    fi2Nmk(dtnM1,un,upn,uppn));
%repositorio.fuppnM1 = fuppnM1;
%fdupduTnmk = @(dtnM1)(alfa1Nmk(dtnM1));
%repositorio.fdupduTnmk = fdupduTnmk;
%fduppduTnmk = @(dtnM1)(alfa2Nmk(dtnM1));
%repositorio.fduppduTnmk = fduppduTnmk;

switch otimizacao
    case 1
        %Principais instantes de tempo:
        T0 = 0;
        T1 = T0 + dT0;

        fTetaX1 = @(t)(alfaTeta*t^2/2*double((T0<=t)&&(t<T1)) +...
            (alfaTeta*T1^2/2 + wMax*(t - T1))*double(T1<=t));
        
        fTetapX1 = @(t)(alfaTeta*t*double((T0<=t)&&(t<T1)) +...
            wMax*double(T1<=t));
        
        fTetappX1 = @(t)(alfaTeta*double((T0<=t)&&(t<T1)) +...
            0*double(T1<=t));
        
        hU = @(t)(0);
        
        Auru = IdNg(:,[1:5,7:Ng]);
        AtXu = IdNg(:,6);
        M1uru = Auru.'*(M1gEF*Auru);
        M1tXu = Auru.'*(M1gEF*AtXu);
        Curu = Auru.'*(CgEF*Auru);
        CtXu = Auru.'*(CgEF*AtXu);
        Kuru = Auru.'*(KgEF*Auru);
        KtXu = Auru.'*(KgEF*AtXu);
        fub = @(uTx,tX1)(Auru*uTx + AtXu*tX1);
        
        fcTil = @(uTx,upTx,uppTx,tX1,tpX1,tppX1)(...
            Auru.'*...
            fcEFb(fub(uTx,tX1),fub(upTx,tpX1),fub(uppTx,tppX1)));
        dubduTxT = Auru;
        dfcTilduTxT = @(uTx,upTx,uppTx,tX1,tpX1,tppX1)(...
            Auru.'*...
            dfcEFbdubT(fub(uTx,tX1),fub(upTx,tpX1),fub(uppTx,tppX1))*...
            dubduTxT);
        dubpdupTxT = Auru;
        dfcTildupTxT = @(uTx,upTx,tX1,tpX1)(...
            Auru.'*...
            dfcEFbdubpT(fub(uTx,tX1),fub(upTx,tpX1))*...
            dubpdupTxT);
        
        %fdcTil = @(uTx,upTx,uppTx,tX1,tpX1,tppX1)(...
        %    Auru.'*...
        %    fdcEFb(fub(uTx,tX1),fub(upTx,tpX1),fub(uppTx,tppX1)));
        %dfdcTilduTxT = @(uTx,upTx,uppTx,tX1,tpX1,tppX1)(...
        %    Auru.'*...
        %    dfdcEFbdubT(fub(uTx,tX1),fub(upTx,tpX1),fub(uppTx,tppX1))*...
        %    dubduTxT);
        %dfdcTildupTxT = @(uTx,upTx,tX1,tpX1)(...
        %    Auru.'*...
        %    dfdcEFbdubpT(fub(uTx,tX1),fub(upTx,tpX1))*...
        %    dubpdupTxT);
        
        dubppduppTxT = Auru;
        dfTilduppTxT = @(uTx,tX1)(...
            Auru.'*...
            dfEFbdubppT(fub(uTx,tX1))*...
            dubppduppTxT);
        
        %Newmark:
        Knmk = @(dtnM1)(alfa2Nmk(dtnM1)*M1uru + alfa1Nmk(dtnM1)*Curu + Kuru);
        fcTilnM1 = @(dtnM1,ubnM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
            fcTil(ubnM1,...
                  fupnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
                  fuppnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
                  tX1nM1,tpX1nM1,tppX1nM1));
        dfcTilduTxTnM1 = @(dtnM1,ubnM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
            dfcTilduTxT(ubnM1,...
                        fupnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
                        fuppnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
                        tX1nM1,tpX1nM1,tppX1nM1));
        dfcTildupTxTnM1 = @(dtnM1,ubnM1,tX1nM1,tpX1nM1,ubn,ubpn,ubppn)(...
            dfcTildupTxT(ubnM1,...
                         fupnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
                         tX1nM1,tpX1nM1));
        %fdcTilnM1 = @(dtnM1,ubnM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
        %    fdcTil(ubnM1,...
        %           fupnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
        %           fuppnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
        %           tX1nM1,tpX1nM1,tppX1nM1));
        %dfdcTilduTxTnM1 = @(dtnM1,ubnM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
        %    dfdcTilduTxT(ubnM1,...
        %                 fupnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
        %                 fuppnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
        %                 tX1nM1,tpX1nM1,tppX1nM1));
        %dfdcTildupTxTnM1 = @(dtnM1,ubnM1,tX1nM1,tpX1nM1,ubn,ubpn,ubppn)(...
        %    dfdcTildupTxT(ubnM1,...
        %                  fupnM1(dtnM1,ubnM1,ubn,ubpn,ubppn),...
        %                  tX1nM1,tpX1nM1));
        dfTilduppTxTnM1 = @(ubrnM1,tX1nM1)(dfTilduppTxT(ubrnM1,tX1nM1));
        %Derivadas totais:
        dubpnM1dubnM1T = @(dtnM1)(alfa1Nmk(dtnM1));
        dubppnM1dubnM1T = @(dtnM1)(alfa2Nmk(dtnM1));
        DfcTilDuTxnM1T = @(dtnM1,ubnM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
            dfcTilduTxTnM1(dtnM1,ubnM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn) +...
            dfcTildupTxTnM1(dtnM1,ubnM1,tX1nM1,tpX1nM1,ubn,ubpn,ubppn)*...
            dubpnM1dubnM1T(dtnM1) +...
            dfTilduppTxTnM1(ubnM1,tX1nM1)*...
            dubppnM1dubnM1T(dtnM1));
        %DfdcTilDuTxnM1T = @(dtnM1,ubnM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
        %    dfdcTilduTxTnM1(dtnM1,ubnM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn) +...
        %    dfdcTildupTxTnM1(dtnM1,ubnM1,tX1nM1,tpX1nM1,ubn,ubpn,ubppn)*...
        %    dubpnM1dubnM1T(dtnM1) +...
        %    dfTilduppTxTnM1(ubnM1,tX1nM1)*...
        %    dubppnM1dubnM1T(dtnM1));
        
        %Restrições extrínsecas (multiplicadores de Lagrange):
        IdNgm1MrM1 = eye(Ng-1+rEstr+1);
        Aurz = IdNgm1MrM1(:,1:Ng-1);
        Almbz = IdNgm1MrM1(:,Ng-1+1:Ng-1+rEstr+1);
        GamaMA = [IdNg(6*1-5,:); 
                  GamaR];
        GamaMAu = GamaMA*Auru;
        %GamaMAtX = GamaMA*AtXu;
        hTil = @(t)([hU(t);
                     zeros(rEstr,1)]);
        rEstrH = length(hTil(0));
        Knmkz = @(dtnM1)(...
            [Knmk(dtnM1), kNmk*GamaMAu.'; 
             kNmk*GamaMAu, zeros(rEstrH)]);
        fcTilznM1 = @(dtnM1,tnM1,znM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
            [fcTilnM1(dtnM1,Aurz.'*znM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn); 
             -kNmk*hTil(tnM1)]);
        %fdcTilznM1 = @(dtnM1,tnM1,znM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
        %    [fdcTilnM1(dtnM1,Aurz.'*znM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn); 
        %     -kNmk*hTil(tnM1)]);
        KnmkTxz = @(tX1,tpX1,tppX1)(...
            [M1tXu*tppX1 + CtXu*tpX1 + KtXu*tX1; 
             zeros(rEstrH,1)]);
        fiNmkzn = @(dtnM1,ubn,ubpn,ubppn)(...
            [M1uru*fi2Nmk(dtnM1,ubn,ubpn,ubppn) + Curu*fi1Nmk(dtnM1,ubn,ubpn,ubppn); 
             zeros(rEstrH,1)]);
        duTxdzT = Aurz.';
        dfcTilzdzT = @(dtnM1,znM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
            [DfcTilDuTxnM1T(dtnM1,Aurz.'*znM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)*duTxdzT; 
             zeros(rEstrH,Ng-1+rEstrH)]);
        %dfdcTilzdzT = @(dtnM1,znM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)(...
        %    [DfdcTilDuTxnM1T(dtnM1,Aurz.'*znM1,tX1nM1,tpX1nM1,tppX1nM1,ubn,ubpn,ubppn)*duTxdzT; 
        %     zeros(rEstrH,Ng-1+rEstrH)]);
        %Vetor de seleção de variáveis ciclicas:
        IdLVC = zeros(Ng,1);
        for i = 1:N+1
            n = 6*i;
            IdLVC = IdLVC + IdNg(:,n);
        end
        %Matrizes de seleção de variáveis:
        IdU = zeros(N+1,Ng);
        IdV = zeros(N+1,Ng);
        IdTetaZ = zeros(N+1,Ng);
        IdW = zeros(N+1,Ng);
        IdTetaY = zeros(N+1,Ng);
        IdTetaX = zeros(N+1,Ng);
        for i = 1:N+1
            nU = 6*i-5; nV = 6*i-4; nTz = 6*i-3; nW = 6*i-2; nTy = 6*i-1; nTx = 6*i;
            IdU(i,:) = IdNg(nU,:);
            IdV(i,:) = IdNg(nV,:);
            IdTetaZ(i,:) = IdNg(nTz,:);
            IdW(i,:) = IdNg(nW,:);
            IdTetaY(i,:) = IdNg(nTy,:);
            IdTetaX(i,:) = IdNg(nTx,:);
        end
    otherwise
        disp('other value')
end

%%
%Integração:
%t0 = argumentos.t0;
%dt = argumentos.dt_newmark;
%T = argumentos.T;
%nT = argumentos.nT;
switch otimizacao
    case 1
        uTilTx0 = zeros(Ng-1,1);
        uTilpTx0 = zeros(Ng-1,1);
        uTilppTx0 = zeros(Ng-1,1);
        lmb0 = zeros(rEstr+1,1);
        ZZ = zeros(nT,3*(Ng-1)+rEstr+1+3*1);
        ZZ(1,:) = [uTilTx0.', uTilpTx0.', uTilppTx0.', lmb0.',fTetaX1(t0),fTetapX1(t0),fTetappX1(t0)];
        uTilTxn = uTilTx0;
        uTilpTxn = uTilpTx0;
        uTilppTxn = uTilppTx0;
        lmbn = lmb0;
        
        iOtm = 1;
        sum2Otm = 0;
        for i = 2:nT
            tnM1 = T(i,1);
            dtnM1 = dt;
            uTilTxnM10 = uTilTxn + dtnM1*uTilpTxn + 0.5*(dtnM1*uTilppTxn)*dtnM1;
            lmbnM10 = lmbn;
            znM10 = [uTilTxnM10; lmbnM10];
            %Integração:
            Eta0 = znM10;
            Psi = @(eta)(Knmkz(dtnM1)*eta +...
                fcTilznM1(dtnM1,tnM1,eta,fTetaX1(tnM1),fTetapX1(tnM1),fTetappX1(tnM1),uTilTxn,uTilpTxn,uTilppTxn) +...
                KnmkTxz(fTetaX1(tnM1),fTetapX1(tnM1),fTetappX1(tnM1)) +...
                fiNmkzn(dtnM1,uTilTxn,uTilpTxn,uTilppTxn));
            dPsidEtaT = @(eta)(Knmkz(dtnM1) +...
                dfcTilzdzT(dtnM1,eta,fTetaX1(tnM1),fTetapX1(tnM1),fTetappX1(tnM1),uTilTxn,uTilpTxn,uTilppTxn));
            [ Eta_conv ] = f_Newton_Raphson( Eta0, Psi, dPsidEtaT, argumentos );
            znM1 = Eta_conv;
            uTilTxnM1 = Aurz.'*znM1;
            lmbnM1 = Almbz.'*znM1;
            uTilpTxnM1 = fupnM1(dtnM1,uTilTxnM1,uTilTxn,uTilpTxn,uTilppTxn);
            uTilppTxnM1 = fuppnM1(dtnM1,uTilTxnM1,uTilTxn,uTilpTxn,uTilppTxn);
            %Armazenamento:
            ZZ(i,:) = [uTilTxnM1.', uTilpTxnM1.', uTilppTxnM1.', lmbnM1.',fTetaX1(tnM1),fTetapX1(tnM1),fTetappX1(tnM1)];
            %Atualização:
            uTilTxn = uTilTxnM1;
            uTilpTxn = uTilpTxnM1;
            uTilppTxn = uTilppTxnM1;
            lmbn = lmbnM1;
            %Otimização:
            if (tnM1 - dt/2 < TempoEns(iOtm,1)) && (TempoEns(iOtm,1) <= tnM1 + dt/2)
                ubpEFnM1 = Auru*uTilpTxnM1 + AtXu*fTetapX1(tnM1);
                tpXNM1 = ubpEFnM1(Ng,1);
                sum2Otm = sum2Otm + (tpXNM1 - TetapXNM1enc(iOtm,1))^2;
                iOtm = iOtm + 1;
            end
        end
    otherwise
        disp('other value')
end

%%
%SAÍDAS
switch otimizacao
    case 1
        %ZZ(i,:) = [uTilTxnM1.', uTilpTxnM1.', uTilppTxnM1.', lmbnM1.',tX1,tpX1,tppX1];
        uTx = ZZ(:,1:Ng-1);
        upTx = ZZ(:,Ng-1+1:2*(Ng-1));
        uppTx = ZZ(:,2*(Ng-1)+1:3*(Ng-1));
        lmb = kNmk*ZZ(:,3*(Ng-1)+1:3*(Ng-1)+rEstrH);
        tX1 = ZZ(:,3*(Ng-1)+rEstrH+1);
        tpX1 = ZZ(:,3*(Ng-1)+rEstrH+2);
        tppX1 = ZZ(:,3*(Ng-1)+rEstrH+3);
        ub = uTx*Auru.' + tX1*AtXu.';
        ubp = upTx*Auru.' + tpX1*AtXu.';
        ubpp = uppTx*Auru.' + tppX1*AtXu.';
        
        ubU = ub*IdU.';
        ubV = ub*IdV.';
        ubTz = ub*IdTetaZ.';
        ubW = ub*IdW.';
        ubTy = ub*IdTetaY.';
        ubTx = ub*IdTetaX.';
        ubpU = ubp*IdU.';
        ubpV = ubp*IdV.';
        ubpTz = ubp*IdTetaZ.';
        ubpW = ubp*IdW.';
        ubpTy = ubp*IdTetaY.';
        ubpTx = ubp*IdTetaX.';
        ubppU = ubpp*IdU.';
        ubppV = ubpp*IdV.';
        ubppTz = ubpp*IdTetaZ.';
        ubppW = ubpp*IdW.';
        ubppTy = ubpp*IdTetaY.';
        ubppTx = ubpp*IdTetaX.';
        
        y1 = ubpTx(:,N+1);
        ubNM1 = ubU(:,N+1);
        y2 = FnbNM1(ubNM1);
        vL = ubV(:,N1+1);
        wL = ubW(:,N1+1);
        uL = sqrt(vL.^2 + wL.^2);
        
        %Entradas:
        figure
        plot(T,lmb(:,1),'k')
        xlabel('Tempo (s)')
        ylabel('LmbU (N)')
        title('Força de reação')
        grid
        %Saídas:
        figure
        plot(T,y1*30/pi,'k',T,TetapX1enc*30/pi,'r')
        xlabel('Tempo (s)')
        ylabel('y1 (RPM)')
        legend('simulação','ensaio')
        title('Velocidade TetaXp do rotor principal')
        grid
        figure
        plot(T,y2,'k')
        xlabel('Tempo (s)')
        ylabel('y2 (N)')
        title('Força normal de contato')
        grid
        %Posições longitudinais:
        figure
        plot(T,u1*10^3,'k',T,u2*10^3,'r',T,u3*10^3,'b')
        xlabel('Tempo (s)')
        ylabel('u (mm)')
        title('Posições longitudinais (u)')
        legend('ub1','ub2','ub3')
        grid
        %Posições laterais:
        figure
        plot(T,vL*10^3,'b',T,wL*10^3,'r',T,uL*10^3,'k')
        xlabel('Tempo (s)')
        ylabel('Deslocamento lateral (mm)')
        legend('vL','wL','uL')
        grid
        teta_fg = 0:0.001:(2*pi);
        figure
        plot(vL*10^3,wL*10^3,'r',fg*10^3*cos(teta_fg),fg*10^3*sin(teta_fg),'k')
        xlabel('yL (mm)')
        ylabel('zL (mm)')
        axis equal
        legend('órbita','folga')
        grid
        %Reações referentes às restrições:
        figure
        plot(T,lmb(:,2),'k',T,lmb(:,4),'r',T,lmb(:,6),'b',T,lmb(:,8),'g')
        xlabel('Tempo (s)')
        ylabel('Reações (N)')
        legend('lmbV1','lmbW1','lmbVNM1','lmbWNM1')
        title('Reações de força nas extremidades')
        grid
        figure
        plot(T,lmb(:,3),'k',T,lmb(:,5),'r',T,lmb(:,7),'b',T,lmb(:,9),'g')
        xlabel('Tempo (s)')
        ylabel('Reações (Nm)')
        legend('lmbTz1','lmbTy1','lmbTzNM1','lmbTyNM1')
        title('Reações de momento nas extremidades')
        grid
    otherwise
        disp('other value')
end